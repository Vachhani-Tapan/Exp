<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>LedgerCore - Expense Management</title>
    <script src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap"
        rel="stylesheet">

    <style>
        * {
            box-sizing: border-box;
        }

        :root {
            --primary-color: #8b5cf6;
            --primary-color-darker: #2575fc;
            --solid-black: #111827;
            --text-color: #F9FAFB;
            --text-color-muted: #9CA3AF;
            --card-bg-dark: rgba(31, 41, 55, 0.5);
            --card-border-dark: rgba(255, 255, 255, 0.1);
        }

        html {
            background-color: var(--solid-black);
        }

        body {
            font-family: "Inter", "Segoe UI", sans-serif;
            background-color: var(--solid-black);
            color: var(--text-color);
            margin: 0;
            min-height: 100vh;
        }

        #root {
            width: 100%;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0;
            box-sizing: border-box;
            position: relative;
            overflow-x: hidden;
        }

        .view-container {
            width: 100%;
            display: flex;
            justify-content: center;
            animation: fadeIn 0.6s cubic-bezier(0.25, 0.46, 0.45, 0.94) both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.98);
            }

            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .landing-page {
            width: 100%;
            color: var(--text-color);
            background-color: #111827;
        }

        .landing-nav {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem 2rem;
            max-width: 1280px;
            margin: 0 auto;
        }

        .landing-nav .logo {
            font-weight: 700;
            font-size: 1.5rem;
            color: #F9FAFB;
        }

        .landing-nav .nav-links a {
            margin: 0 1rem;
            text-decoration: none;
            color: var(--text-color-muted);
            font-weight: 600;
        }

        .landing-nav .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            background-color: var(--primary-color);
            color: white;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .landing-nav .btn:hover {
            background-color: #7c3aed;
        }

        .hero-section {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 4rem 2rem;
            max-width: 1280px;
            margin: 0 auto;
            gap: 2rem;
        }

        .hero-content {
            max-width: 500px;
        }

        .hero-content h1 {
            font-size: 3.5rem;
            font-weight: 700;
            line-height: 1.2;
            margin-bottom: 1rem;
            color: #F9FAFB;
        }

        .hero-content p {
            font-size: 1.1rem;
            color: var(--text-color-muted);
            margin-bottom: 2rem;
        }

        .hero-buttons .btn {
            margin-right: 1rem;
            padding: 1rem 2rem;
            font-size: 1.1rem;
            font-weight: 600;
            border: 2px solid transparent;
        }

        .hero-buttons .btn-secondary {
            background-color: transparent;
            color: var(--primary-color);
            border: 2px solid var(--primary-color);
        }

        .hero-buttons .btn-secondary:hover {
            background-color: var(--primary-color);
            color: white;
        }

        .hero-image img {
            width: 100%;
            max-width: 600px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.25);
        }

        .trusted-section {
            background-color: #1F2937;
            padding: 3rem 2rem;
            text-align: center;
        }

        .trusted-section h3 {
            color: var(--text-color-muted);
            text-transform: uppercase;
            letter-spacing: 2px;
            margin-bottom: 2rem;
        }

        .logos {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 3rem;
            filter: grayscale(100%) invert(1);
            opacity: 0.6;
        }

        .auth-wrapper {
            width: 100%;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .signup-box {
            background: var(--card-bg-dark);
            backdrop-filter: blur(15px);
            border: 1px solid var(--card-border-dark);
            padding: 40px;
            border-radius: 16px;
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 420px;
            text-align: center;
        }

        .signup-box h2 {
            border: none;
            padding-bottom: 0;
            margin-bottom: 10px;
            color: var(--text-color);
            font-size: 28px;
            text-shadow: 0 0 8px rgba(139, 92, 246, 0.6);
        }

        .signup-box p {
            color: var(--text-color-muted);
            margin-bottom: 30px;
        }

        .auth-wrapper .input-group {
            position: relative;
            margin-bottom: 25px;
            text-align: left;
        }

        .auth-wrapper input,
        .auth-wrapper select {
            width: 100%;
            padding: 14px;
            box-sizing: border-box;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            background: transparent;
            color: var(--text-color);
            outline: none;
            transition: all 0.3s;
        }

        .auth-wrapper input::placeholder {
            color: transparent;
        }

        .auth-wrapper label {
            position: absolute;
            top: 15px;
            left: 15px;
            color: var(--text-color-muted);
            pointer-events: none;
            transition: all 0.3s ease-out;
        }

        .auth-wrapper input:focus+label,
        .auth-wrapper input:not(:placeholder-shown)+label {
            top: -10px;
            left: 10px;
            transform: scale(0.85);
            background-color: var(--primary-color);
            padding: 2px 8px;
            border-radius: 4px;
            color: #fff;
            font-weight: 600;
        }

        .auth-wrapper button[type="submit"] {
            width: 100%;
            padding: 14px;
            background-color: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease-out;
            margin-top: 25px;
            margin-bottom: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .auth-wrapper button[type="submit"]:hover {
            background-color: #7c3aed;
        }

        .login-link {
            color: var(--text-color-muted);
        }

        .login-link a {
            color: var(--primary-color);
            text-decoration: none;
            font-weight: 700;
            cursor: pointer;
        }

        .role-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
        }

        .role-selector button {
            flex: 1;
            padding: 10px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: transparent;
            color: var(--text-color-muted);
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s;
        }

        .role-selector button.active {
            background: var(--primary-color);
            color: #fff;
            border-color: var(--primary-color);
        }

        .dashboard-wrapper {
            max-width: 1280px;
            width: 100%;
            margin: auto;
            position: relative;
            z-index: 1;
            padding: 1rem;
        }

        .dashboard h2,
        .dashboard h3 {
            margin: 1rem 0 0.75rem;
            color: var(--primary-color);
            border-bottom: 1px solid #374151;
            padding-bottom: 8px;
        }

        .dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 24px;
        }

        .card {
            width: 100%;
            background-color: #1F2937;
            border: 1px solid #374151;
            padding: 24px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
            overflow: hidden;
            /* Ensures content curves with border */
        }

        ul {
            list-style: none;
            margin: 0;
            padding: 0;
        }

        li {
            background: #374151;
            margin-bottom: 12px;
            padding: 12px 16px;
            border-radius: 8px;
            display: flex;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #4B5563;
        }

        button.approve-btn,
        button.reject-btn,
        button.logout-btn,
        button.delete-btn,
        button.backup-btn,
        button.assign-btn {
            margin-left: 10px;
            margin-bottom: 1vw;
            padding: 6px 16px;
            font-weight: 600;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        button.approve-btn {
            background-color: #16a34a;
            color: white;
        }

        button.reject-btn,
        button.logout-btn {
            background-color: #dc2626;
            color: white;
        }

        button.delete-btn {
            background-color: #9ca3af;
            color: #1f2937;
        }

        button.backup-btn {
            background-color: #2563eb;
            color: white;
        }

        button.assign-btn {
            background-color: #7c3aed;
            color: white;
        }

        .message {
            margin-top: 16px;
            text-align: center;
            padding: 12px 16px;
            border-radius: 8px;
            font-weight: 700;
        }

        .message.error {
            background-color: #991b1b;
            color: #fef2f2;
        }

        .message.success {
            background-color: #166534;
            color: #dcfce7;
        }

        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .summary-card {
            background: #1F2937;
            text-align: center;
            padding: 1rem;
            border-radius: 8px;
            border: 1px solid #374151;
        }

        .summary-card .value {
            font-size: 2rem;
            font-weight: 700;
            color: var(--primary-color);
        }

        .summary-card .label {
            font-size: 0.9rem;
            color: var(--text-color-muted);
        }

        .dashboard-wrapper input,
        .dashboard-wrapper select {
            width: 100%;
            padding: 10px;
            box-sizing: border-box;
            border: 1px solid #4B5563;
            border-radius: 8px;
            background-color: #374151;
            color: var(--text-color);
            margin-bottom: 0.5rem;
            margin-top: 1.5vw;
        }

        .dashboard-wrapper form input,
        .dashboard-wrapper form select {
            margin-bottom: 1rem;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }

        .status-pending {
            background: #fef3c7;
            color: #92400e;
        }

        .status-manager-approved {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-approved {
            background: #dcfce7;
            color: #166534;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }

        .data-management {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .data-management button {
            padding: 8px 16px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .data-management button:hover {
            transform: translateY(-2px);
        }

        .file-input {
            display: none;
        }

        .file-input-label {
            display: inline-block;
            padding: 8px 16px;
            background-color: #374151;
            color: white;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: background-color 0.3s;
        }

        .file-input-label:hover {
            background-color: #4B5563;
        }

        .user-management {
            margin-bottom: 20px;
            grid-column: 1 / -1;
            /* Make it span full width */
        }

        .user-management h3 {
            margin-bottom: 15px;
            color: var(--primary-color);
        }

        .assign-manager-form {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 15px;
            align-items: end;
            margin-bottom: 20px;
            padding: 20px;
            background: #374151;
            border-radius: 8px;
            border: 1px solid #4B5563;
        }

        .assign-manager-form>div {
            display: flex;
            flex-direction: column;
        }

        .assign-manager-form label {
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
        }

        .user-list {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 20px;
        }

        .user-card {
            background: #374151;
            padding: 16px 20px;
            border-radius: 8px;
            border: 1px solid #4B5563;
            transition: transform 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .user-card h4 {
            margin: 0;
            color: var(--primary-color);
            font-size: 1.1rem;
            min-width: 200px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .user-card p {
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.4;
            color: var(--text-color-muted);
        }

        .user-card-details {
            display: flex;
            gap: 30px;
            align-items: center;
            flex-grow: 1;
        }

        /* Notification System Styles */
        .notification-container {
            position: relative;
            margin-right: 15px;
        }

        .notification-bell {
            background: transparent;
            border: none;
            color: var(--text-color-muted);
            font-size: 1.5rem;
            cursor: pointer;
            padding: 5px;
            position: relative;
            transition: color 0.2s;
        }

        .notification-bell:hover {
            color: var(--primary-color);
        }

        .notification-badge {
            position: absolute;
            top: 0;
            right: 0;
            background-color: #EF4444;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 0.7rem;
            display: flex;
            justify-content: center;
            align-items: center;
            border: 2px solid #111827;
        }

        .notification-panel {
            position: absolute;
            top: 100%;
            right: 0;
            width: 350px;
            background-color: #1F2937;
            border: 1px solid #374151;
            border-radius: 8px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
            animation: fadeIn 0.2s ease-out;
        }

        .notification-header {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-header h4 {
            margin: 0;
            color: var(--text-color);
        }

        .clear-btn {
            background: transparent;
            border: none;
            color: var(--text-color-muted);
            font-size: 0.8rem;
            cursor: pointer;
        }

        .clear-btn:hover {
            color: var(--primary-color);
        }

        .notification-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .notification-item {
            padding: 12px 16px;
            border-bottom: 1px solid #374151;
            transition: background 0.2s;
            display: flex;
            flex-direction: column;
            gap: 4px;
            /* Override default li styles */
            background: transparent;
            margin-bottom: 0;
            border-radius: 0;
            border-top: none;
            border-left: none;
            border-right: none;
            flex-wrap: nowrap;
            justify-content: flex-start;
            align-items: flex-start;
        }

        .notification-item:hover {
            background-color: #374151;
        }

        .notification-item.unread {
            background-color: rgba(139, 92, 246, 0.1);
        }

        .notification-item.unread:hover {
            background-color: rgba(139, 92, 246, 0.2);
        }

        .notification-msg {
            font-size: 0.9rem;
            color: var(--text-color);
        }

        .notification-time {
            font-size: 0.75rem;
            color: var(--text-color-muted);
        }

        /* Tab Navigation */
        .admin-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 24px;
            border-bottom: 1px solid #374151;
            padding-bottom: 0px;
        }

        .admin-nav button {
            background: transparent;
            border: none;
            color: var(--text-color-muted);
            font-size: 1rem;
            font-weight: 600;
            padding: 10px 4px;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
        }

        .admin-nav button.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .admin-nav button:hover {
            color: var(--text-color);
        }

        /* Budget Progress Bars */
        .budget-progress {
            width: 100%;
            height: 10px;
            background-color: #374151;
            border-radius: 5px;
            margin-top: 10px;
            overflow: hidden;
        }

        .budget-fill {
            height: 100%;
            border-radius: 5px;
            transition: width 0.5s ease;
        }

        /* Custom Scrollbar for Modal */
        .custom-scrollbar::-webkit-scrollbar {
            width: 8px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: #1f2937;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: #4b5563;
            border-radius: 4px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: #6b7280;
        }

        /* Security Settings Styles */
        .security-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px;
            background: #1F2937;
            border: 1px solid #374151;
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .security-info h4 {
            margin: 0 0 4px 0;
            font-size: 1.1rem;
            color: #F9FAFB;
        }

        .security-info p {
            margin: 0;
            font-size: 0.9rem;
            color: #9CA3AF;
        }

        .security-action select {
            background: #1F2937;
            color: white;
            border: 1px solid #374151;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            outline: none;
        }

        /* Toggle Switch Styles */
        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 26px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #374151;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked+.slider {
            background-color: #2563EB;
        }

        input:checked+.slider:before {
            transform: translateX(24px);
        }
    </style>
</head>

<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect } = React;

        // SIMPLE DATABASE - Everything in one place
        const initialData = {
            users: [],
            expenses: [],
            notifications: [],
            budgets: [],
            settings: {
                sessionTimeout: 30,
                loginNotifications: true
            }
        };

        // Notification Components
        function NotificationPanel({ notifications, onClear, onClose }) {
            useEffect(() => {
                gsap.fromTo(".notification-panel",
                    { opacity: 0, y: -10, scale: 0.95 },
                    { opacity: 1, y: 0, scale: 1, duration: 0.3, ease: "power2.out" }
                );
            }, []);

            return (
                <div className="notification-panel">
                    <div className="notification-header">
                        <h4>Notifications</h4>
                        {notifications.length > 0 && (
                            <button className="clear-btn" onClick={onClear}>Clear All</button>
                        )}
                    </div>
                    {notifications.length > 0 ? (
                        <ul className="notification-list">
                            {notifications.map(note => (
                                <li key={note.id} className={`notification-item ${!note.read ? 'unread' : ''}`}>
                                    <span className="notification-msg">{note.message}</span>
                                    <span className="notification-time">{new Date(note.date).toLocaleString()}</span>
                                </li>
                            ))}
                        </ul>
                    ) : (
                        <div style={{ padding: '20px', textAlign: 'center', color: '#9CA3AF', fontStyle: 'italic' }}>
                            No notifications
                        </div>
                    )}
                </div>
            );
        }

        // Profile Page Component - Full Page View
        function ProfilePage({ user, onUpdateProfile, users }) {
            const [isEditing, setIsEditing] = useState(false);
            const [name, setName] = useState(user.name || '');
            const [phone, setPhone] = useState(user.phone || '');
            const [showPasswordModal, setShowPasswordModal] = useState(false);
            const [currentPassword, setCurrentPassword] = useState('');
            const [newPassword, setNewPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [twoFactorEnabled, setTwoFactorEnabled] = useState(user.twoFactorEnabled || false);
            const [message, setMessage] = useState({ text: '', type: '' });
            const [showCameraModal, setShowCameraModal] = useState(false);
            const [isCapturing, setIsCapturing] = useState(false);
            const [capturedImage, setCapturedImage] = useState(null);
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);

            const uniqueId = user.uniqueId || '84729103';
            const memberSince = user.created || new Date().toLocaleDateString();
            const [profileImage, setProfileImage] = useState(user.profileImage || '');

            useEffect(() => {
                gsap.from(".profile-page", { opacity: 0, y: 20, duration: 0.5, ease: "power2.out" });

                // Cleanup camera tracks on unmount
                return () => {
                    if (videoRef.current && videoRef.current.srcObject) {
                        const tracks = videoRef.current.srcObject.getTracks();
                        tracks.forEach(track => track.stop());
                    }
                };
            }, []);

            // Sync local state when user prop changes
            useEffect(() => {
                setProfileImage(user.profileImage || '');
                setTwoFactorEnabled(user.twoFactorEnabled || false);
                if (!isEditing) {
                    setName(user.name || '');
                    setPhone(user.phone || '');
                }
            }, [user]);

            const handleSaveProfile = () => {
                const updatedUser = {
                    ...user,
                    name: name,
                    phone: phone,
                };
                onUpdateProfile(updatedUser);
                setIsEditing(false);
                setMessage({ text: 'Profile updated successfully!', type: 'success' });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const handlePasswordChange = () => {
                if (currentPassword !== user.password) {
                    setMessage({ text: 'Current password is incorrect!', type: 'error' });
                    return;
                }
                if (newPassword !== confirmPassword) {
                    setMessage({ text: 'New passwords do not match!', type: 'error' });
                    return;
                }
                if (newPassword.length < 8) {
                    setMessage({ text: 'Password must be at least 8 characters!', type: 'error' });
                    return;
                }

                const updatedUser = { ...user, password: newPassword };
                onUpdateProfile(updatedUser);
                setShowPasswordModal(false);
                setCurrentPassword('');
                setNewPassword('');
                setConfirmPassword('');
                setMessage({ text: 'Password changed successfully!', type: 'success' });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const handlePhotoUpload = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onloadend = () => {
                        const base64String = reader.result;
                        setProfileImage(base64String);
                        const updatedUser = { ...user, profileImage: base64String };
                        onUpdateProfile(updatedUser);
                        setMessage({ text: 'Profile photo updated!', type: 'success' });
                        setTimeout(() => setMessage({ text: '', type: '' }), 3000);
                    };
                    reader.readAsDataURL(file);
                }
            };

            const handleToggle2FA = () => {
                if (!profileImage && !twoFactorEnabled) {
                    setMessage({
                        text: 'Please upload or capture a profile photo before enabling 2FA.',
                        type: 'error'
                    });
                    setTimeout(() => setMessage({ text: '', type: '' }), 4000);
                    return;
                }
                const newValue = !twoFactorEnabled;
                setTwoFactorEnabled(newValue);
                const updatedUser = { ...user, twoFactorEnabled: newValue };
                onUpdateProfile(updatedUser);
                setMessage({
                    text: newValue ? 'Two-Factor Authentication enabled!' : 'Two-Factor Authentication disabled!',
                    type: 'success'
                });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const startCamera = async () => {
                setShowCameraModal(true);
                setIsCapturing(true);
                setCapturedImage(null);
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ video: { width: 400, height: 400, facingMode: 'user' } });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    alert("Could not access camera. Please ensure you've granted permission.");
                    setShowCameraModal(false);
                }
            };

            const stopCamera = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    const tracks = videoRef.current.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
                setShowCameraModal(false);
            };

            const capturePhoto = () => {
                const video = videoRef.current;
                const canvas = canvasRef.current;
                if (video && canvas) {
                    const context = canvas.getContext('2d');
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    const dataUrl = canvas.toDataURL('image/jpeg');
                    setCapturedImage(dataUrl);
                    setIsCapturing(false);

                    // Stop the camera stream tracks but keep the modal open for preview
                    if (video.srcObject) {
                        const tracks = video.srcObject.getTracks();
                        tracks.forEach(track => track.stop());
                    }
                }
            };

            const saveCapturedPhoto = () => {
                if (capturedImage) {
                    setProfileImage(capturedImage);
                    const updatedUser = { ...user, profileImage: capturedImage };
                    onUpdateProfile(updatedUser);
                    setMessage({ text: 'Profile photo updated!', type: 'success' });
                    setTimeout(() => setMessage({ text: '', type: '' }), 3000);
                    setShowCameraModal(false); // Close the modal after saving
                }
            };

            return (
                <div className="profile-page" style={{ maxWidth: '900px', margin: '0 auto', color: '#1F2937' }}>
                    {/* Message Display */}
                    {message.text && (
                        <div style={{
                            padding: '12px 20px',
                            borderRadius: '8px',
                            marginBottom: '20px',
                            background: message.type === 'error' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)',
                            color: message.type === 'error' ? '#EF4444' : '#10B981',
                            fontWeight: '600',
                            display: 'flex',
                            alignItems: 'center',
                            gap: '10px',
                            border: `1px solid ${message.type === 'error' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)'}`
                        }}>
                            {message.type === 'error' ? '❌' : '✅'} {message.text}
                        </div>
                    )}

                    {/* Gradient Header Card */}
                    <div style={{
                        background: 'linear-gradient(90deg, #2563EB 0%, #7C3AED 100%)',
                        borderRadius: '12px 12px 0 0',
                        padding: '40px 32px',
                        position: 'relative'
                    }}>
                        <div style={{ display: 'flex', alignItems: 'center', gap: '24px' }}>
                            {/* Avatar */}
                            <div style={{ position: 'relative' }}>
                                <div style={{
                                    width: '120px',
                                    height: '120px',
                                    borderRadius: '50%',
                                    background: profileImage ? `url("${profileImage}")` : 'rgba(59, 130, 246, 0.5)',
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    border: '4px solid rgba(255,255,255,0.1)',
                                    overflow: 'hidden'
                                }}>
                                    {!profileImage && (
                                        <svg width="60" height="60" viewBox="0 0 24 24" fill="none" stroke="white" strokeWidth="1.5" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    )}
                                </div>
                                <div style={{ display: 'flex', gap: '8px', position: 'absolute', bottom: '5px', right: '-10px' }}>
                                    <label style={{
                                        width: '32px', height: '32px', borderRadius: '50%', background: 'white',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)', cursor: 'pointer'
                                    }} title="Upload Photo">
                                        <input type="file" accept="image/*" onChange={handlePhotoUpload} style={{ display: 'none' }} />
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4B5563" strokeWidth="2">
                                            <path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"></path>
                                            <polyline points="17 8 12 3 7 8"></polyline>
                                            <line x1="12" y1="3" x2="12" y2="15"></line>
                                        </svg>
                                    </label>
                                    <button onClick={startCamera} style={{
                                        width: '32px', height: '32px', borderRadius: '50%', background: 'white',
                                        display: 'flex', alignItems: 'center', justifyContent: 'center',
                                        boxShadow: '0 2px 4px rgba(0,0,0,0.1)', cursor: 'pointer', border: 'none'
                                    }} title="Take Live Photo">
                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="#4B5563" strokeWidth="2">
                                            <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
                                            <circle cx="12" cy="13" r="4"></circle>
                                        </svg>
                                    </button>
                                </div>
                            </div>

                            {/* User Info */}
                            <div style={{ flex: 1 }}>
                                <h1 style={{ color: 'white', fontSize: '2.5rem', margin: '0 0 4px 0', fontWeight: 'bold' }}>{user.name}</h1>
                                <p style={{ color: 'rgba(255,255,255,0.9)', margin: '0 0 8px 0', fontSize: '1.2rem' }}>{user.email}</p>
                                <p style={{ color: 'rgba(255,255,255,0.8)', margin: '0 0 16px 0', fontSize: '1rem', fontStyle: 'italic' }}>{user.role} | {uniqueId}</p>
                                <span style={{
                                    background: user.role === 'ADMIN' ? '#FEE2E2' : '#DBEAFE',
                                    color: user.role === 'ADMIN' ? '#EF4444' : '#2563EB',
                                    padding: '6px 16px',
                                    borderRadius: '50px',
                                    fontSize: '0.85rem',
                                    fontWeight: '600'
                                }}>
                                    {user.role === 'ADMIN' ? 'Admin' : user.role === 'MANAGER' ? 'Manager' : 'Employee'}
                                </span>
                            </div>
                        </div>
                    </div>

                    <div style={{ background: 'white', padding: '32px', borderRadius: '0 0 12px 12px', border: '1px solid #E5E7EB', borderTop: 'none' }}>
                        {/* Profile Information Section */}
                        <div style={{ marginBottom: '40px' }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                                <h2 style={{ color: '#111827', margin: 0, fontSize: '1.5rem', fontWeight: 'bold' }}>Profile Information</h2>
                                {!isEditing ? (
                                    <button
                                        type="button"
                                        onClick={() => setIsEditing(true)}
                                        style={{
                                            background: '#2563EB',
                                            color: 'white',
                                            border: 'none',
                                            padding: '10px 24px',
                                            borderRadius: '8px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px',
                                            fontSize: '1rem'
                                        }}
                                    >
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                        Edit Profile
                                    </button>
                                ) : (
                                    <div style={{ display: 'flex', gap: '12px' }}>
                                        <button
                                            type="button"
                                            onClick={() => setIsEditing(false)}
                                            style={{ background: 'transparent', color: '#4B5563', border: '1px solid #D1D5DB', padding: '10px 24px', borderRadius: '8px', fontWeight: 'bold', cursor: 'pointer' }}
                                        >
                                            Cancel
                                        </button>
                                        <button
                                            type="button"
                                            onClick={handleSaveProfile}
                                            style={{ background: '#10B981', color: 'white', border: 'none', padding: '10px 24px', borderRadius: '8px', fontWeight: 'bold', cursor: 'pointer' }}
                                        >
                                            Save Changes
                                        </button>
                                    </div>
                                )}
                            </div>

                            {/* Info Grid */}
                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                                {/* Full Name */}
                                <div style={{ background: '#F9FAFB', padding: '20px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '20px', border: '1px solid #F3F4F6' }}>
                                    <div style={{ color: '#9CA3AF' }}>
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                            <circle cx="12" cy="7" r="4"></circle>
                                        </svg>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ color: '#4B5563', fontSize: '0.9rem', marginBottom: '4px', fontWeight: '500' }}>Full Name</div>
                                        {isEditing ? (
                                            <input
                                                type="text"
                                                value={name}
                                                onChange={e => setName(e.target.value)}
                                                style={{ width: '100%', padding: '8px', borderRadius: '6px', background: 'white', color: '#1F2937', border: '1px solid #D1D5DB' }}
                                            />
                                        ) : (
                                            <div style={{ color: '#111827', fontWeight: 'bold', fontSize: '1.1rem' }}>{user.name}</div>
                                        )}
                                    </div>
                                </div>

                                {/* Phone Number */}
                                <div style={{ background: '#F9FAFB', padding: '20px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '20px', border: '1px solid #F3F4F6' }}>
                                    <div style={{ color: '#9CA3AF' }}>
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                                        </svg>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ color: '#4B5563', fontSize: '0.9rem', marginBottom: '4px', fontWeight: '500' }}>Phone Number</div>
                                        {isEditing ? (
                                            <input
                                                type="tel"
                                                value={phone}
                                                onChange={e => setPhone(e.target.value)}
                                                placeholder="Enter phone number"
                                                style={{ width: '100%', padding: '8px', borderRadius: '6px', background: 'white', color: '#1F2937', border: '1px solid #D1D5DB' }}
                                            />
                                        ) : (
                                            <div style={{ color: user.phone ? '#111827' : '#9CA3AF', fontWeight: 'bold', fontSize: '1.1rem' }}>{user.phone || 'Not provided'}</div>
                                        )}
                                    </div>
                                </div>

                                {/* Email Address */}
                                <div style={{ background: '#F9FAFB', padding: '20px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '20px', border: '1px solid #F3F4F6' }}>
                                    <div style={{ color: '#9CA3AF' }}>
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                                            <path d="m22 7-8.97 5.7a1.94 1.94 0 0 1-2.06 0L2 7"></path>
                                        </svg>
                                    </div>
                                    <div style={{ flex: 1 }}>
                                        <div style={{ color: '#4B5563', fontSize: '0.9rem', marginBottom: '4px', fontWeight: '500' }}>Email Address</div>
                                        <div style={{ color: '#111827', fontWeight: 'bold', fontSize: '1.1rem' }}>{user.email}</div>
                                    </div>
                                </div>


                            </div>
                        </div>

                        {/* Account Details Section */}
                        <div style={{ marginBottom: '40px' }}>
                            <h2 style={{ color: '#111827', margin: '0 0 24px 0', fontSize: '1.5rem', fontWeight: 'bold' }}>Account Details</h2>

                            <div style={{ display: 'grid', gridTemplateColumns: 'repeat(2, 1fr)', gap: '20px' }}>
                                {/* Member Since */}
                                <div style={{ background: '#F9FAFB', padding: '20px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '20px', border: '1px solid #F3F4F6' }}>
                                    <div style={{ color: '#9CA3AF' }}>
                                        <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                            <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                                            <line x1="16" y1="2" x2="16" y2="6"></line>
                                            <line x1="8" y1="2" x2="8" y2="6"></line>
                                            <line x1="3" y1="10" x2="21" y2="10"></line>
                                        </svg>
                                    </div>
                                    <div>
                                        <div style={{ color: '#4B5563', fontSize: '0.9rem', marginBottom: '4px', fontWeight: '500' }}>Member Since</div>
                                        <div style={{ color: '#111827', fontWeight: 'bold', fontSize: '1.1rem' }}>{memberSince}</div>
                                    </div>
                                </div>


                                {/* Reporting Manager ID (if applicable) */}
                                {(user.role === 'EMPLOYEE' || user.role === 'MANAGER') && (
                                    <div style={{ background: '#F9FAFB', padding: '20px', borderRadius: '12px', display: 'flex', alignItems: 'center', gap: '20px', border: '1px solid #F3F4F6' }}>
                                        <div style={{ color: '#6366F1' }}>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </svg>
                                        </div>
                                        <div>
                                            <div style={{ color: '#4B5563', fontSize: '0.9rem', marginBottom: '4px', fontWeight: '500' }}>Reporting Manager</div>
                                            <div style={{ color: '#111827', fontWeight: 'bold', fontSize: '1.1rem' }}>
                                                {(() => {
                                                    const manager = users.find(u => u.id === user.managerId);
                                                    return manager ? `${manager.role} | ${manager.uniqueId}` : 'Not Assigned';
                                                })()}
                                            </div>
                                        </div>
                                    </div>
                                )}
                            </div>
                        </div>

                        {/* Security Settings Section */}
                        <div>
                            <h2 style={{ color: '#111827', margin: '0 0 24px 0', fontSize: '1.5rem', fontWeight: 'bold' }}>Security Settings</h2>

                            <div style={{ display: 'flex', flexDirection: 'column', gap: '16px' }}>
                                {/* Change Password Button */}
                                <button
                                    type="button"
                                    onClick={() => setShowPasswordModal(true)}
                                    style={{
                                        background: 'white',
                                        border: '1px solid #D1D5DB',
                                        color: '#4B5563',
                                        padding: '12px 24px',
                                        borderRadius: '8px',
                                        fontWeight: 'bold',
                                        cursor: 'pointer',
                                        textAlign: 'left',
                                        width: 'fit-content',
                                        fontSize: '1rem',
                                        boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                                    }}
                                >
                                    Change Password
                                </button>

                                {/* 2FA Toggle - Admin Only */}
                                {user.role === 'ADMIN' && (
                                    <button
                                        type="button"
                                        onClick={handleToggle2FA}
                                        style={{
                                            background: 'white',
                                            border: '1px solid #D1D5DB',
                                            color: '#4B5563',
                                            padding: '12px 24px',
                                            borderRadius: '8px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            textAlign: 'left',
                                            width: 'fit-content',
                                            fontSize: '1rem',
                                            display: 'flex',
                                            alignItems: 'center',
                                            gap: '8px',
                                            boxShadow: '0 1px 2px rgba(0,0,0,0.05)'
                                        }}
                                    >
                                        {twoFactorEnabled ? '✓ Two-Factor Authentication Enabled' : 'Enable Two-Factor Authentication'}
                                    </button>
                                )}
                            </div>
                        </div>
                    </div>

                    {/* Password Change Modal */}
                    {showPasswordModal && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.5)', zIndex: 1200, display: 'flex', justifyContent: 'center', alignItems: 'center', padding: '20px', backdropFilter: 'blur(4px)' }}>
                            <div className="card" style={{ width: '450px', position: 'relative', background: 'white', borderRadius: '16px', border: 'none', boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.25)' }}>
                                <button onClick={() => setShowPasswordModal(false)} style={{ position: 'absolute', top: '20px', right: '20px', background: 'transparent', border: 'none', color: '#9CA3AF', fontSize: '1.5rem', cursor: 'pointer' }}>&times;</button>

                                <h3 style={{ margin: '0 0 24px 0', color: '#111827', fontSize: '1.5rem', fontWeight: 'bold' }}>Change Password</h3>

                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', marginBottom: '8px', color: '#4B5563', fontSize: '0.95rem', fontWeight: '600' }}>Current Password</label>
                                    <input
                                        type="password"
                                        value={currentPassword}
                                        onChange={e => setCurrentPassword(e.target.value)}
                                        style={{ width: '100%', padding: '12px', border: '1px solid #D1D5DB', borderRadius: '8px', outline: 'none', fontSize: '1rem' }}
                                    />
                                </div>

                                <div style={{ marginBottom: '20px' }}>
                                    <label style={{ display: 'block', marginBottom: '8px', color: '#4B5563', fontSize: '0.95rem', fontWeight: '600' }}>New Password</label>
                                    <input
                                        type="password"
                                        value={newPassword}
                                        onChange={e => setNewPassword(e.target.value)}
                                        style={{ width: '100%', padding: '12px', border: '1px solid #D1D5DB', borderRadius: '8px', outline: 'none', fontSize: '1rem' }}
                                    />
                                </div>

                                <div style={{ marginBottom: '32px' }}>
                                    <label style={{ display: 'block', marginBottom: '8px', color: '#4B5563', fontSize: '0.95rem', fontWeight: '600' }}>Confirm New Password</label>
                                    <input
                                        type="password"
                                        value={confirmPassword}
                                        onChange={e => setConfirmPassword(e.target.value)}
                                        style={{ width: '100%', padding: '12px', border: '1px solid #D1D5DB', borderRadius: '8px', outline: 'none', fontSize: '1rem' }}
                                    />
                                </div>

                                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                                    <button onClick={() => setShowPasswordModal(false)} style={{ padding: '12px 24px', background: 'transparent', color: '#4B5563', border: '1px solid #D1D5DB', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}>Cancel</button>
                                    <button onClick={handlePasswordChange} style={{ padding: '12px 24px', background: '#2563EB', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}>Update Password</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Camera Modal */}
                    {showCameraModal && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            backgroundColor: 'rgba(0,0,0,0.85)', zIndex: 2000,
                            display: 'flex', justifyContent: 'center', alignItems: 'center',
                            backdropFilter: 'blur(5px)'
                        }}>
                            <div className="card" style={{ width: '450px', padding: '24px', textAlign: 'center', position: 'relative', background: 'white' }}>
                                <button onClick={stopCamera} style={{ position: 'absolute', top: '15px', right: '15px', background: 'transparent', border: 'none', color: '#9CA3AF', fontSize: '1.5rem', cursor: 'pointer' }}>&times;</button>

                                <h3 style={{ marginTop: 0, marginBottom: '20px', color: '#111827', fontWeight: 'bold' }}>Live Photo Capture</h3>

                                <div style={{
                                    width: '100%', aspectRatio: '1/1', background: '#111827',
                                    borderRadius: '12px', overflow: 'hidden', marginBottom: '24px',
                                    border: '2px solid #E5E7EB', position: 'relative'
                                }}>
                                    {isCapturing ? (
                                        <video ref={videoRef} autoPlay playsInline muted style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                    ) : (
                                        <img src={capturedImage} style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                                    )}
                                    <canvas ref={canvasRef} style={{ display: 'none' }} />
                                </div>

                                <div style={{ display: 'flex', gap: '12px', justifyContent: 'center' }}>
                                    {isCapturing ? (
                                        <>
                                            <button onClick={stopCamera} style={{ padding: '12px 24px', background: 'transparent', color: '#4B5563', border: '1px solid #D1D5DB', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}>Cancel</button>
                                            <button onClick={capturePhoto} style={{ padding: '12px 24px', background: '#2563EB', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}>Capture Photo</button>
                                        </>
                                    ) : (
                                        <>
                                            <button onClick={() => { setIsCapturing(true); startCamera(); }} style={{ padding: '12px 24px', background: 'transparent', color: '#2563EB', border: '1px solid #2563EB', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}>Retake</button>
                                            <button onClick={saveCapturedPhoto} style={{ padding: '12px 24px', background: '#10B981', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: 'bold' }}>Save Photo</button>
                                        </>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Enhanced data persistence with multiple storage options
        // Dynamic API URL - works in both development and production
        const API_URL = window.location.hostname === 'localhost'
            ? 'http://localhost:5000/api'
            : '/api';

        const ApiService = {
            async signup(user) {
                const res = await fetch(`${API_URL}/signup`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(user)
                });
                return res.json();
            },
            async login(email, password) {
                const res = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                if (!res.ok) throw new Error('Login failed');
                return res.json();
            },
            async getData() {
                const res = await fetch(`${API_URL}/data`);
                return res.json();
            },
            async saveExpenses(expenses) {
                return fetch(`${API_URL}/expenses`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(expenses)
                });
            },
            async updateExpense(id, status) {
                return fetch(`${API_URL}/expenses/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ status })
                });
            },
            async saveBudget(category, limit) {
                return fetch(`${API_URL}/budgets`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ category, limit })
                });
            },
            async deleteBudget(id) {
                return fetch(`${API_URL}/budgets/${id}`, { method: 'DELETE' });
            },
            async updateUser(id, userData) {
                return fetch(`${API_URL}/users/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(userData)
                });
            },
            async deleteUser(id) {
                return fetch(`${API_URL}/users/${id}`, { method: 'DELETE' });
            },
            async clearNotifications(recipientId) {
                return fetch(`${API_URL}/notifications/clear`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ recipientId })
                });
            },
            async saveNotifications(notifications) {
                return fetch(`${API_URL}/notifications`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(notifications)
                });
            },
            async updateSettings(settings) {
                return fetch(`${API_URL}/settings`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(settings)
                });
            },
            async clearAllData() {
                return fetch(`${API_URL}/clear-all`, { method: 'POST' });
            }
        };

        const DataManager = {
            exportData: (data) => {
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `ledgercore-backup-${new Date().toISOString().split('T')[0]}.json`;
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                URL.revokeObjectURL(url);
            },
            importData: (file, callback) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        callback(importedData);
                    } catch (error) {
                        alert('Invalid file format.');
                    }
                };
                reader.readAsText(file);
            }
        };

        // Face Verification Component
        function FaceVerification({ user, onSuccess, onCancel }) {
            const [status, setStatus] = useState('loading'); // loading, ready, verifying, success, error
            const [message, setMessage] = useState('Loading face recognition models...');
            const videoRef = React.useRef(null);
            const canvasRef = React.useRef(null);
            const [modelsLoaded, setModelsLoaded] = useState(false);

            useEffect(() => {
                const loadModels = async () => {
                    try {
                        const MODEL_URL = 'https://justadudewhohacks.github.io/face-api.js/models';
                        await Promise.all([
                            faceapi.nets.ssdMobilenetv1.loadFromUri(MODEL_URL),
                            faceapi.nets.faceLandmark68Net.loadFromUri(MODEL_URL),
                            faceapi.nets.faceRecognitionNet.loadFromUri(MODEL_URL)
                        ]);
                        setModelsLoaded(true);
                        setStatus('ready');
                        setMessage('Models loaded. Click button to start verification.');
                    } catch (err) {
                        console.error("Error loading models:", err);
                        setMessage("Error loading face recognition models. Please check your internet connection.");
                        setStatus('error');
                    }
                };
                loadModels();

                return () => {
                    stopCamera();
                };
            }, []);

            const startCamera = async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({
                        video: { width: 640, height: 480, facingMode: 'user' }
                    });
                    if (videoRef.current) {
                        videoRef.current.srcObject = stream;
                    }
                } catch (err) {
                    console.error("Error accessing camera:", err);
                    setMessage("Could not access camera. Please ensure permission is granted.");
                    setStatus('error');
                }
            };

            const stopCamera = () => {
                if (videoRef.current && videoRef.current.srcObject) {
                    const tracks = videoRef.current.srcObject.getTracks();
                    tracks.forEach(track => track.stop());
                }
            };

            const handleVerify = async () => {
                if (!modelsLoaded) return;

                setStatus('verifying');
                setMessage('Starting camera and verifying...');

                try {
                    // Start camera for verification
                    await startCamera();

                    // Give camera a moment to stabilize and user to position face
                    setMessage('Stabilizing camera... Stay still.');
                    await new Promise(resolve => setTimeout(resolve, 1500));
                    // 1. Get live face descriptor
                    const detections = await faceapi.detectSingleFace(videoRef.current)
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    // Stop camera immediately after capture attempt
                    stopCamera();

                    if (!detections) {
                        setMessage("No face detected. Please try again.");
                        setStatus('ready');
                        return;
                    }

                    // 2. Get registered face descriptor
                    const img = new Image();
                    img.src = user.profileImage;
                    await new Promise(resolve => img.onload = resolve);

                    const referenceDetections = await faceapi.detectSingleFace(img)
                        .withFaceLandmarks()
                        .withFaceDescriptor();

                    if (!referenceDetections) {
                        setMessage("Could not find a face in your profile photo. Please update your profile photo.");
                        setStatus('error');
                        return;
                    }

                    // 3. Compare descriptors
                    const distance = faceapi.euclideanDistance(detections.descriptor, referenceDetections.descriptor);
                    console.log('Face verification distance:', distance);

                    // Threshold usually 0.6 for ssdMobilenetv1
                    if (distance < 0.6) {
                        setStatus('success');
                        setMessage('Verification successful! Face matched (Score: ' + distance.toFixed(3) + ')');
                        setTimeout(() => onSuccess(), 1500);
                    } else {
                        setStatus('ready');
                        setMessage('Face mismatch (Score: ' + distance.toFixed(3) + '). Please ensure good lighting and face visibility.');
                    }
                } catch (err) {
                    console.error("Verification error:", err);
                    stopCamera();
                    setMessage("An error occurred during verification.");
                    setStatus('error');
                }
            };

            return (
                <div style={{
                    display: 'flex', flexDirection: 'column', alignItems: 'center', justifyContent: 'center',
                    minHeight: '100vh', background: '#0F172A', color: 'white', padding: '20px', fontFamily: 'Inter, sans-serif'
                }}>
                    <div style={{
                        maxWidth: '500px', width: '100%', background: 'rgba(30, 41, 59, 0.7)',
                        padding: '40px', borderRadius: '24px', border: '1px solid rgba(255,255,255,0.1)',
                        backdropFilter: 'blur(10px)', textAlign: 'center', boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5)'
                    }}>
                        <h2 style={{ fontSize: '2rem', marginBottom: '10px', fontWeight: '800', background: 'linear-gradient(to right, #6366F1, #A855F7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>
                            Face Verification
                        </h2>
                        <p style={{ color: '#94A3B8', marginBottom: '30px' }}>Secure your account with 2FA</p>

                        <div style={{
                            width: '100%', aspectRatio: '4/3', background: '#020617',
                            borderRadius: '16px', overflow: 'hidden', marginBottom: '24px',
                            border: '2px solid rgba(255,255,255,0.1)', position: 'relative'
                        }}>
                            <video ref={videoRef} autoPlay playsInline muted style={{ width: '100%', height: '100%', objectFit: 'cover' }} />
                            {status === 'verifying' && (
                                <div style={{
                                    position: 'absolute', top: 0, left: 0, right: 0, bottom: 0,
                                    background: 'rgba(0,0,0,0.4)', display: 'flex', alignItems: 'center', justifyContent: 'center'
                                }}>
                                    <div className="loader"></div>
                                </div>
                            )}
                        </div>

                        <div style={{
                            padding: '12px', borderRadius: '12px', marginBottom: '24px',
                            background: status === 'error' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(99, 102, 241, 0.1)',
                            color: status === 'error' ? '#F87171' : '#A5B4FC',
                            fontSize: '0.95rem', fontWeight: '500', border: `1px solid ${status === 'error' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(99, 102, 241, 0.2)'}`
                        }}>
                            {status === 'loading' ? '⏳ ' : status === 'success' ? '✅ ' : status === 'error' ? '❌ ' : '🛡️ '}
                            {message}
                        </div>

                        <div style={{ display: 'flex', gap: '12px', flexDirection: 'column' }}>
                            <button
                                onClick={handleVerify}
                                disabled={status !== 'ready'}
                                style={{
                                    width: '100%', padding: '14px', borderRadius: '12px',
                                    background: status === 'ready' ? 'linear-gradient(to right, #6366F1, #4F46E5)' : '#334155',
                                    color: 'white', border: 'none', fontWeight: '700', fontSize: '1.1rem',
                                    cursor: status === 'ready' ? 'pointer' : 'not-allowed', transition: 'all 0.2s',
                                    boxShadow: status === 'ready' ? '0 10px 15px -3px rgba(79, 70, 229, 0.4)' : 'none'
                                }}
                            >
                                Verify Identity
                            </button>
                            <button
                                onClick={onCancel}
                                style={{
                                    width: '100%', padding: '12px', borderRadius: '12px',
                                    background: 'transparent', color: '#94A3B8', border: '1px solid #334155',
                                    fontWeight: '600', cursor: 'pointer', transition: 'all 0.2s'
                                }}
                            >
                                Cancel & Back to Login
                            </button>
                        </div>
                    </div>

                    <style>{`
                        .loader {
                            border: 4px solid rgba(255, 255, 255, 0.1);
                            border-left-color: #6366F1;
                            border-radius: 50%;
                            width: 40px;
                            height: 40px;
                            animation: spin 1s linear infinite;
                        }
                        @keyframes spin {
                            to { transform: rotate(360deg); }
                        }
                    `}</style>
                </div>
            );
        }

        // Landing Page
        function LandingPage({ switchToLogin, switchToSignUp }) {
            useEffect(() => {
                const tl = gsap.timeline();
                tl.from(".hero-section h1", { opacity: 0, y: 30, duration: 0.8, ease: "power3.out" })
                    .from(".hero-section p", { opacity: 0, y: 20, duration: 0.8, ease: "power3.out" }, "-=0.6")
                    .from(".cta-buttons button", { opacity: 0, y: 20, stagger: 0.2, duration: 0.6, ease: "power2.out" }, "-=0.6");
            }, []);

            return (
                <div className="landing-container">
                    <nav className="landing-nav">
                        <div className="logo">LedgerCore</div>
                        <div className="nav-links">
                            <a href="#">Solutions</a>
                            <a href="#">Platform</a>
                            <a href="#">Pricing</a>
                            <a href="#">Company</a>
                        </div>
                        <div>
                            <button type="button" className="btn" onClick={switchToLogin}>Login</button>
                        </div>
                    </nav>
                    <section className="hero-section">
                        <div className="hero-content">
                            <h1>Expense management software</h1>
                            <p>Choose expense management software that shows you employee expenses in real time. Monitor team budgets, track requests and approvals, reimburse expenses, and embrace admin.</p>
                            <div className="hero-buttons">
                                <button type="button" className="btn" onClick={switchToSignUp}>Sign Up</button>
                                <button type="button" className="btn btn-secondary" onClick={switchToLogin}>Login</button>
                            </div>
                        </div>
                        <div className="hero-image">
                            <img src="https://res.cloudinary.com/ddmt5vrxi/image/upload/v1759568782/WhatsApp_Image_2025-10-04_at_14.32.14_bb031eed_rhiykz.jpg" alt="Expense management app screenshot" />
                        </div>
                    </section>
                    <section className="trusted-section">
                        <h3>THOUSANDS OF WORLD-CLASS COMPANIES STREAMLINE EXPENSES WITH LedgerCore</h3>
                        <div className="logos">
                            <span>ALGOLIA</span>
                            <span>ITRS</span>
                            <span>Habito</span>
                            <span>SECURA</span>
                            <span>NICKEL</span>
                        </div>
                    </section>
                </div>
            );
        }

        // Sign Up Page
        function SignUpPage({ onSignUp, switchToLogin, message }) {
            const [name, setName] = useState('');
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const [confirmPassword, setConfirmPassword] = useState('');
            const [role, setRole] = useState('EMPLOYEE');
            const handleSubmit = (e) => { e.preventDefault(); onSignUp({ name, email, password, confirmPassword, role }); };

            return (
                <div className="auth-wrapper">
                    <div className="signup-box">
                        <h2>Create Your Account</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="input-group"><input type="text" value={name} onChange={e => setName(e.target.value)} placeholder=" " required /><label>Full Name</label></div>
                            <div className="input-group"><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder=" " required /><label>Email</label></div>
                            <div className="input-group">
                                <div className="role-selector">
                                    <button type="button" onClick={() => setRole('EMPLOYEE')} className={role === 'EMPLOYEE' ? 'active' : ''}>Employee</button>
                                    <button type="button" onClick={() => setRole('MANAGER')} className={role === 'MANAGER' ? 'active' : ''}>Manager</button>
                                    <button type="button" onClick={() => setRole('ADMIN')} className={role === 'ADMIN' ? 'active' : ''}>Admin</button>
                                </div>
                            </div>
                            <div className="input-group"><input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder=" " required minLength="8" /><label>Password</label></div>
                            <div className="input-group"><input type="password" value={confirmPassword} onChange={e => setConfirmPassword(e.target.value)} placeholder=" " required /><label>Confirm Password</label></div>
                            <button type="submit">Sign Up</button>
                        </form>
                        {message && message.text && (
                            <div className={`message ${message.type}`}>
                                {message.text}
                            </div>
                        )}
                        <div className="login-link">Already have an account? <a onClick={switchToLogin}>Log In</a></div>
                    </div>
                </div>
            );
        }

        // Login Page
        function LoginPage({ onLogin, switchToSignUp, message }) {
            const [email, setEmail] = useState('');
            const [password, setPassword] = useState('');
            const handleSubmit = (e) => { e.preventDefault(); onLogin(email, password); };

            return (
                <div className="auth-wrapper">
                    <div className="signup-box" style={{ border: message && message.type === 'error' ? '2px solid #dc2626' : '' }}>
                        <h2>Welcome Back</h2>
                        <form onSubmit={handleSubmit}>
                            <div className="input-group"><input type="email" value={email} onChange={e => setEmail(e.target.value)} placeholder=" " required /><label>Email</label></div>
                            <div className="input-group"><input type="password" value={password} onChange={e => setPassword(e.target.value)} placeholder=" " required /><label>Password</label></div>
                            <button type="submit">Login</button>
                        </form>
                        {message && message.text && (
                            <div className={`message ${message.type}`}>
                                {message.text}
                            </div>
                        )}
                        <div className="login-link">Don't have an account? <a onClick={switchToSignUp}>Sign Up</a></div>
                    </div>
                </div>
            );
        }

        // Employee Dashboard
        function EmployeeDashboard({ loggedInUser, expenses, users, onExpenseSubmit, onUpdateProfile }) {
            const [localExpenses, setLocalExpenses] = useState([]);
            const [activeTab, setActiveTab] = useState('overview');
            const [newExpense, setNewExpense] = useState({
                name: '',
                amount: '',
                category: 'Meals',
                date: new Date().toISOString().split('T')[0]
            });

            useEffect(() => {
                gsap.from(".dashboard .card", {
                    opacity: 0,
                    y: 30,
                    stagger: 0.15,
                    duration: 0.6,
                    ease: "power2.out"
                });
            }, [activeTab]); // Redo animation on tab change

            // Load local expenses
            useEffect(() => {
                const stored = localStorage.getItem(`local_expenses_${loggedInUser.id}`);
                if (stored) {
                    setLocalExpenses(JSON.parse(stored));
                }
            }, [loggedInUser.id]);

            // Get submitted expenses for this employee
            const submittedExpenses = expenses.filter(exp => exp.employeeId === loggedInUser.id);

            const handleAddExpense = (e) => {
                e.preventDefault();
                if (!newExpense.name || !newExpense.amount) {
                    alert('Please fill all fields');
                    return;
                }

                const expense = {
                    id: Date.now(),
                    name: newExpense.name,
                    amount: parseFloat(newExpense.amount),
                    category: newExpense.category,
                    date: newExpense.date
                };

                const updated = [...localExpenses, expense];
                setLocalExpenses(updated);
                localStorage.setItem(`local_expenses_${loggedInUser.id}`, JSON.stringify(updated));

                // Reset form
                setNewExpense({
                    name: '',
                    amount: '',
                    category: 'Meals',
                    date: new Date().toISOString().split('T')[0]
                });
            };

            const handleSubmitForApproval = () => {
                if (localExpenses.length === 0) {
                    alert('No expenses to submit');
                    return;
                }

                if (window.confirm(`Submit ${localExpenses.length} expenses for approval?`)) {
                    onExpenseSubmit(localExpenses);
                    setLocalExpenses([]);
                    localStorage.removeItem(`local_expenses_${loggedInUser.id}`);
                    alert('Expenses submitted successfully!');
                }
            };

            const formatCurrency = (val) => `₹${Number(val).toLocaleString('en-IN')}`;

            return (
                <div className="dashboard-container">
                    <div className="admin-nav">
                        <button
                            className={activeTab === 'overview' ? 'active' : ''}
                            onClick={() => setActiveTab('overview')}
                        >
                            Overview
                        </button>
                        <button
                            className={activeTab === 'profile' ? 'active' : ''}
                            onClick={() => setActiveTab('profile')}
                        >
                            My Profile
                        </button>
                    </div>

                    {activeTab === 'profile' ? (
                        <ProfilePage
                            user={loggedInUser}
                            onUpdateProfile={onUpdateProfile}
                            users={users}
                        />
                    ) : (
                        <div className="dashboard">
                            <div className="card" style={{ gridColumn: '1 / -1' }}>
                                <h2>Add New Expense</h2>
                                <form onSubmit={handleAddExpense}>
                                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '1rem' }}>
                                        <div>
                                            <label>Expense Name</label>
                                            <input
                                                type="text"
                                                value={newExpense.name}
                                                onChange={e => setNewExpense({ ...newExpense, name: e.target.value })}
                                                placeholder="Lunch with client"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label>Amount (₹)</label>
                                            <input
                                                type="number"
                                                value={newExpense.amount}
                                                onChange={e => setNewExpense({ ...newExpense, amount: e.target.value })}
                                                placeholder="1000"
                                                required
                                            />
                                        </div>
                                        <div>
                                            <label>Category</label>
                                            <select
                                                value={newExpense.category}
                                                onChange={e => setNewExpense({ ...newExpense, category: e.target.value })}
                                                required
                                            >
                                                <option value="Meals">Meals</option>
                                                <option value="Travel">Travel</option>
                                                <option value="Supplies">Supplies</option>
                                                <option value="Software">Software</option>
                                                <option value="Other">Other</option>
                                            </select>
                                        </div>
                                        <div>
                                            <label>Date</label>
                                            <input
                                                type="date"
                                                value={newExpense.date}
                                                onChange={e => setNewExpense({ ...newExpense, date: e.target.value })}
                                                required
                                            />
                                        </div>
                                    </div>
                                    <button type="submit" className="approve-btn" style={{ marginTop: '1rem' }}>Add Expense</button>
                                </form>
                            </div>

                            <div className="card" style={{ gridColumn: '1 / -1' }}>
                                <h2>My Expenses</h2>

                                <div style={{ marginBottom: '2rem' }}>
                                    <h3 style={{ fontSize: '1.2rem', borderBottom: '1px solid #4B5563', paddingBottom: '0.5rem' }}>
                                        Drafts ({localExpenses.length})
                                    </h3>
                                    {localExpenses.length > 0 ? (
                                        <ul>
                                            {localExpenses.map(exp => (
                                                <li key={exp.id}>
                                                    <div>
                                                        <strong>{exp.name}</strong><br />
                                                        {formatCurrency(exp.amount)} • {exp.category}<br />
                                                        <small>{exp.date}</small>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : <p style={{ color: '#9CA3AF', fontStyle: 'italic' }}>No unsubmitted expenses</p>}

                                    {localExpenses.length > 0 && (
                                        <button type="button" className="approve-btn" onClick={handleSubmitForApproval} style={{ width: '100%', marginTop: '1rem' }}>
                                            Submit {localExpenses.length} Expenses for Approval
                                        </button>
                                    )}
                                </div>

                                <div>
                                    <h3 style={{ fontSize: '1.2rem', borderBottom: '1px solid #4B5563', paddingBottom: '0.5rem' }}>
                                        History ({submittedExpenses.length})
                                    </h3>
                                    {submittedExpenses.length > 0 ? (
                                        <ul>
                                            {submittedExpenses.map(exp => (
                                                <li key={exp.id}>
                                                    <div>
                                                        <strong>{exp.name}</strong><br />
                                                        {formatCurrency(exp.amount)} • {exp.category}<br />
                                                        <small>{exp.date}</small>
                                                    </div>
                                                    <span className={`status-badge status-${exp.status.toLowerCase().replace('_', '-')}`}>
                                                        {exp.status.replace('_', ' ')}
                                                    </span>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : <p style={{ color: '#9CA3AF', fontStyle: 'italic' }}>No submitted expenses</p>}
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Analytics Component
        function AnalyticsModal({ expenses, users, onClose }) {
            const canvasRef = React.useRef(null);
            const chartInstance = React.useRef(null);
            const [selectedCategory, setSelectedCategory] = useState(null);

            // Lock body scroll when modal is open
            useEffect(() => {
                document.body.style.overflow = 'hidden';
                gsap.from(".analytics-modal-card", { scale: 0.9, opacity: 0, duration: 0.3, ease: "back.out(1.2)" });
                return () => {
                    document.body.style.overflow = 'unset';
                };
            }, []);

            useEffect(() => {
                if (canvasRef.current && expenses.length > 0 && !selectedCategory) {
                    if (chartInstance.current) {
                        chartInstance.current.destroy();
                    }

                    const ctx = canvasRef.current.getContext('2d');

                    // Aggregate expenses by category
                    const categoryTotals = expenses.reduce((acc, curr) => {
                        acc[curr.category] = (acc[curr.category] || 0) + curr.amount;
                        return acc;
                    }, {});

                    chartInstance.current = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: Object.keys(categoryTotals),
                            datasets: [{
                                label: 'Expenses by Category (₹)',
                                data: Object.values(categoryTotals),
                                backgroundColor: [
                                    'rgba(139, 92, 246, 0.6)',
                                    'rgba(37, 117, 252, 0.6)',
                                    'rgba(16, 185, 129, 0.6)',
                                    'rgba(245, 158, 11, 0.6)',
                                    'rgba(239, 68, 68, 0.6)'
                                ],
                                borderColor: 'rgba(255, 255, 255, 0.1)',
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            plugins: {
                                legend: { labels: { color: '#F9FAFB' } },
                                tooltip: {
                                    callbacks: {
                                        label: function (context) {
                                            return `₹${context.parsed.y.toLocaleString('en-IN')}`;
                                        }
                                    }
                                }
                            },
                            scales: {
                                y: {
                                    beginAtZero: true,
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#9CA3AF' }
                                },
                                x: {
                                    grid: { color: 'rgba(255, 255, 255, 0.1)' },
                                    ticks: { color: '#9CA3AF' }
                                }
                            },
                            onClick: (event, elements) => {
                                if (elements.length > 0) {
                                    const index = elements[0].index;
                                    const category = Object.keys(categoryTotals)[index];
                                    setSelectedCategory(category);
                                }
                            },
                            onHover: (event, elements) => {
                                event.native.target.style.cursor = elements.length ? 'pointer' : 'default';
                            }
                        }
                    });
                }

                return () => {
                    if (chartInstance.current) chartInstance.current.destroy();
                };
            }, [expenses, selectedCategory]);

            // Filter expenses for the selected category
            const detailedExpenses = selectedCategory
                ? expenses.filter(e => e.category === selectedCategory).sort((a, b) => new Date(b.date) - new Date(a.date))
                : [];

            const getUserName = (userId) => {
                const user = users.find(u => u.id === userId);
                return user ? user.name : 'Unknown User';
            };

            const formatCurrency = (val) => `₹${Number(val).toLocaleString('en-IN')}`;

            return ReactDOM.createPortal(
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    backgroundColor: 'rgba(0,0,0,0.85)', zIndex: 1000,
                    display: 'flex', justifyContent: 'center', alignItems: 'center',
                    backdropFilter: 'blur(5px)'
                }} onClick={onClose}>
                    <div className="card analytics-modal-card"
                        style={{ width: '90%', maxWidth: '800px', maxHeight: '90vh', overflowY: 'auto', position: 'relative', display: 'flex', flexDirection: 'column' }}
                        onClick={e => e.stopPropagation()} // Prevent close on card click
                    >
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '20px', alignItems: 'center' }}>
                            <h2 style={{ border: 'none', padding: 0, margin: 0 }}>
                                {selectedCategory ? `${selectedCategory} Expenses` : 'Expense Analytics'}
                            </h2>
                            <button type="button" onClick={onClose} style={{ background: 'transparent', border: 'none', color: 'white', fontSize: '2rem', cursor: 'pointer', lineHeight: 1 }}>&times;</button>
                        </div>

                        {selectedCategory ? (
                            <div style={{ animation: 'fadeIn 0.3s ease' }}>
                                <button
                                    type="button"
                                    onClick={() => setSelectedCategory(null)}
                                    style={{
                                        marginBottom: '15px',
                                        padding: '5px 10px',
                                        background: 'transparent',
                                        border: '1px solid #6B7280',
                                        color: '#D1D5DB',
                                        borderRadius: '4px',
                                        cursor: 'pointer'
                                    }}
                                >
                                    &larr; Back to Chart
                                </button>
                                {detailedExpenses.length > 0 ? (
                                    <table style={{ width: '100%', borderCollapse: 'collapse', color: '#E5E7EB' }}>
                                        <thead>
                                            <tr style={{ borderBottom: '1px solid #374151', textAlign: 'left' }}>
                                                <th style={{ padding: '10px' }}>Date</th>
                                                <th style={{ padding: '10px' }}>Employee</th>
                                                <th style={{ padding: '10px' }}>Description</th>
                                                <th style={{ padding: '10px', textAlign: 'right' }}>Amount</th>
                                                <th style={{ padding: '10px' }}>Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {detailedExpenses.map(exp => (
                                                <tr key={exp.id} style={{ borderBottom: '1px solid #374151' }}>
                                                    <td style={{ padding: '10px' }}>{exp.date}</td>
                                                    <td style={{ padding: '10px' }}>{getUserName(exp.employeeId)}</td>
                                                    <td style={{ padding: '10px' }}>{exp.name}</td>
                                                    <td style={{ padding: '10px', textAlign: 'right', fontWeight: 'bold' }}>{formatCurrency(exp.amount)}</td>
                                                    <td style={{ padding: '10px' }}>
                                                        <span className={`status-badge status-${exp.status.toLowerCase().replace('_', '-')}`} style={{ fontSize: '0.75rem' }}>
                                                            {exp.status.replace('_', ' ')}
                                                        </span>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                ) : (
                                    <p>No expenses found for this category.</p>
                                )}
                            </div>
                        ) : (
                            <>
                                {expenses.length > 0 ? (
                                    <div style={{ position: 'relative', height: '400px', width: '100%' }}>
                                        <canvas ref={canvasRef}></canvas>
                                    </div>
                                ) : (
                                    <p>No expense data available to chart.</p>
                                )}
                                {expenses.length > 0 && (
                                    <p style={{ textAlign: 'center', marginTop: '10px', color: '#9CA3AF', fontSize: '0.9rem' }}>
                                        Click on a bar to view details
                                    </p>
                                )}
                            </>
                        )}
                    </div>
                </div>,
                document.body
            );
        }

        // Budget Detail Modal with Analytics
        function BudgetDetailModal({ budget, expenses, users, onClose }) {
            const canvasRef = React.useRef(null);

            // Filter expenses for this budget category (Approved only)
            const budgetExpenses = expenses
                .filter(e => e.category === budget.category && e.status === 'APPROVED')
                .sort((a, b) => new Date(a.date) - new Date(b.date));

            const getUserName = (userId) => {
                const user = users.find(u => u.id === userId);
                return user ? user.name : 'Unknown';
            };

            useEffect(() => {
                if (!canvasRef.current || budgetExpenses.length === 0) return;

                // Group by date
                const expensesByDate = {};
                budgetExpenses.forEach(exp => {
                    expensesByDate[exp.date] = (expensesByDate[exp.date] || 0) + exp.amount;
                });

                const labels = Object.keys(expensesByDate);
                const data = Object.values(expensesByDate);

                const ctx = canvasRef.current.getContext('2d');
                const chart = new Chart(ctx, {
                    type: 'bar', // Changed to Bar Chart
                    data: {
                        labels: labels,
                        datasets: [{
                            label: `Daily Spending: ${budget.category}`,
                            data: data,
                            backgroundColor: 'rgba(139, 92, 246, 0.6)', // Solid bars
                            borderColor: '#8b5cf6',
                            borderWidth: 1,
                            borderRadius: 4,
                            barPercentage: 0.6
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { labels: { color: '#9CA3AF' } }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                grid: { color: '#374151' },
                                ticks: { color: '#9CA3AF' }
                            },
                            x: {
                                grid: { color: '#374151' },
                                ticks: { color: '#9CA3AF' }
                            }
                        }
                    }
                });

                return () => chart.destroy();
            }, [budgetExpenses]);

            const formatCurrency = (val) => `₹${Number(val).toLocaleString('en-IN')}`;

            return (
                <div style={{
                    position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                    backgroundColor: 'rgba(0, 0, 0, 0.8)',
                    backdropFilter: 'blur(8px)',
                    display: 'flex', justifyContent: 'center', alignItems: 'center',
                    zIndex: 1000,
                    padding: '20px'
                }}>
                    <div className="custom-scrollbar" style={{
                        backgroundColor: '#1F2937',
                        borderRadius: '16px',
                        width: '100%',
                        maxWidth: '900px',
                        maxHeight: '90vh',
                        overflowY: 'auto',
                        boxShadow: '0 25px 50px -12px rgba(0, 0, 0, 0.5)',
                        border: '1px solid #374151'
                    }}>
                        <div style={{
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            padding: '30px 30px 20px 30px',
                            borderBottom: '1px solid #374151',
                            marginBottom: '20px',
                            background: '#1F2937',
                            position: 'sticky',
                            top: 0,
                            zIndex: 20
                        }}>
                            <div>
                                <h2 style={{ margin: '0 0 5px 0', color: '#F9FAFB', fontSize: '1.5rem' }}>{budget.category} Analytics</h2>
                                <p style={{ margin: 0, color: '#9CA3AF', fontSize: '0.9rem' }}>Detailed breakdown of expenses and trends</p>
                            </div>
                            <button
                                type="button"
                                onClick={onClose}
                                style={{
                                    background: '#374151',
                                    border: 'none',
                                    color: '#E5E7EB',
                                    width: '32px',
                                    height: '32px',
                                    borderRadius: '50%',
                                    cursor: 'pointer',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center',
                                    fontSize: '1.2rem',
                                    transition: 'background 0.2s'
                                }}
                                onMouseEnter={(e) => e.target.style.background = '#4B5563'}
                                onMouseLeave={(e) => e.target.style.background = '#374151'}
                            >&times;</button>
                        </div>

                        {/* Chart Section */}
                        <div style={{ height: '350px', marginBottom: '40px', background: '#111827', padding: '20px', borderRadius: '12px', border: '1px solid #374151' }}>
                            {budgetExpenses.length > 0 ? (
                                <canvas ref={canvasRef}></canvas>
                            ) : (
                                <div style={{ height: '100%', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#6B7280' }}>
                                    No expense history for this category
                                </div>
                            )}
                        </div>

                        {/* History Table */}
                        {/* History Table */}
                        <div style={{ background: '#111827', padding: '20px', borderRadius: '12px', border: '1px solid #374151' }}>
                            <h3 style={{ borderBottom: '1px solid #374151', paddingBottom: '15px', marginBottom: '20px', color: '#F3F4F6', fontSize: '1.2rem', marginTop: 0 }}>Expense History</h3>

                            {budgetExpenses.length > 0 ? (
                                <table style={{ width: '100%', borderCollapse: 'separate', borderSpacing: '0 8px', color: '#E5E7EB' }}>
                                    <thead style={{ position: 'sticky', top: '0px', zIndex: 10 }}>
                                        <tr style={{ textAlign: 'left', color: '#9CA3AF', fontSize: '0.85rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                                            <th style={{ padding: '0 16px 12px 16px', borderBottom: '1px solid #374151', width: '20%' }}>Date</th>
                                            <th style={{ padding: '0 16px 12px 16px', borderBottom: '1px solid #374151', width: '25%' }}>Employee</th>
                                            <th style={{ padding: '0 16px 12px 16px', borderBottom: '1px solid #374151', width: '35%' }}>Description</th>
                                            <th style={{ padding: '0 16px 12px 16px', borderBottom: '1px solid #374151', width: '20%', textAlign: 'right' }}>Amount</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {budgetExpenses.map(exp => (
                                            <tr key={exp.id} style={{ background: '#1F2937', transition: 'transform 0.2s, box-shadow 0.2s', cursor: 'default' }}
                                                onMouseEnter={e => { e.currentTarget.style.transform = 'translateY(-2px)'; e.currentTarget.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.5)'; }}
                                                onMouseLeave={e => { e.currentTarget.style.transform = 'translateY(0)'; e.currentTarget.style.boxShadow = 'none'; }}>
                                                <td style={{ padding: '16px', borderRadius: '8px 0 0 8px', color: '#D1D5DB' }}>{exp.date}</td>
                                                <td style={{ padding: '16px', color: '#E5E7EB', fontWeight: '500' }}>{getUserName(exp.employeeId)}</td>
                                                <td style={{ padding: '16px', color: '#9CA3AF' }}>{exp.name}</td>
                                                <td style={{ padding: '16px', borderRadius: '0 8px 8px 0', textAlign: 'right', fontWeight: 'bold', color: '#10B981', fontSize: '1.1rem' }}>{formatCurrency(exp.amount)}</td>
                                            </tr>
                                        ))}
                                    </tbody>
                                </table>
                            ) : (
                                <div style={{ textAlign: 'center', padding: '20px', color: '#6B7280', fontStyle: 'italic' }}>
                                    No approved expenses recorded yet.
                                </div>
                            )}
                        </div>
                    </div>

                </div>
            );
        }

        // Budget Management Component
        function BudgetManagement({ budgets, expenses, users, onAddBudget, onEditBudget, onDeleteBudget }) {
            const [showCreateForm, setShowCreateForm] = useState(false);
            const [category, setCategory] = useState('Meals');
            const [amount, setAmount] = useState('');
            const [selectedBudget, setSelectedBudget] = useState(null); // For detail view
            const [editingBudget, setEditingBudget] = useState(null); // For edit modal

            const handleAdd = (e) => {
                e.preventDefault();
                if (!amount) return;
                onAddBudget(category, parseFloat(amount));
                setAmount('');
                setShowCreateForm(false);
            };

            const handleUpdate = (e) => {
                e.preventDefault();
                if (!amount) return;
                onEditBudget(editingBudget.id, parseFloat(amount));
                setEditingBudget(null);
                setAmount('');
            };

            const confirmDelete = (e, id) => {
                e.preventDefault();
                e.stopPropagation(); // Prevent opening detail view
                if (window.confirm("Are you sure you want to delete this budget?")) {
                    onDeleteBudget(id);
                }
            };

            const startEdit = (e, budget) => {
                e.preventDefault();
                e.stopPropagation();
                setEditingBudget(budget);
                setAmount(budget.limit);
            };

            const categories = ['Meals', 'Travel', 'Supplies', 'Software', 'Other'];

            // Calculate usage per category
            const getBudgetStats = (budget) => {
                const used = expenses
                    .filter(e => e.category === budget.category && e.status === 'APPROVED')
                    .reduce((sum, e) => sum + e.amount, 0);
                const remaining = budget.limit - used;
                const percent = Math.min((used / budget.limit) * 100, 100);
                return { used, remaining, percent };
            };

            // Global Stats
            const totalBudget = budgets.reduce((sum, b) => sum + b.limit, 0);

            // For total spent, we only care about categories that HAVE a budget
            const budgetedCategories = budgets.map(b => b.category);
            const totalSpent = expenses
                .filter(e => budgetedCategories.includes(e.category) && e.status === 'APPROVED')
                .reduce((sum, e) => sum + e.amount, 0);

            const totalRemaining = totalBudget - totalSpent;

            const formatCurrency = (val) => `₹${Number(val).toLocaleString('en-IN')}`;

            return (
                <div style={{ width: '100%', maxWidth: '1280px', margin: '0 auto' }}>
                    {selectedBudget && (
                        <BudgetDetailModal
                            budget={selectedBudget}
                            expenses={expenses}
                            users={users}
                            onClose={() => setSelectedBudget(null)}
                        />
                    )}

                    {/* Header Section */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '30px' }}>
                        <div>
                            <h2 style={{ fontSize: '1.8rem', marginBottom: '8px', color: '#F9FAFB' }}>Budget Management</h2>
                            <p style={{ color: '#9CA3AF', margin: 0 }}>Monitor and control spending across categories and departments</p>
                        </div>
                        <button
                            onClick={() => setShowCreateForm(!showCreateForm)}
                            className="assign-btn"
                            style={{
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                padding: '12px 24px',
                                fontSize: '1rem',
                                background: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)',
                                boxShadow: '0 4px 6px -1px rgba(139, 92, 246, 0.4)'
                            }}
                        >
                            <span style={{ fontSize: '1.2rem' }}>+</span> Create Budget
                        </button>
                    </div>

                    {/* Edit Budget Modal (Simple) */}
                    {editingBudget && (
                        <div style={{
                            position: 'fixed', top: 0, left: 0, right: 0, bottom: 0,
                            backgroundColor: 'rgba(0,0,0,0.7)', zIndex: 1100,
                            display: 'flex', justifyContent: 'center', alignItems: 'center'
                        }}>
                            <div className="card" style={{ width: '400px', animation: 'fadeIn 0.2s' }}>
                                <h3>Edit Budget: {editingBudget.category}</h3>
                                <form onSubmit={handleUpdate}>
                                    <label>New Limit</label>
                                    <input
                                        type="number"
                                        value={amount}
                                        onChange={e => setAmount(e.target.value)}
                                        required
                                    />
                                    <div style={{ display: 'flex', gap: '10px', marginTop: '15px' }}>
                                        <button type="submit" className="approve-btn">Update</button>
                                        <button type="button" className="delete-btn" onClick={() => { setEditingBudget(null); setAmount(''); }}>Cancel</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    )}

                    {/* Create Budget Form (Toggleable) */}
                    {showCreateForm && (
                        <div className="card" style={{ marginBottom: '30px', animation: 'fadeIn 0.3s ease' }}>
                            <h3 style={{ marginTop: 0, marginBottom: '20px' }}>Set New Budget</h3>
                            <form onSubmit={handleAdd} style={{ display: 'flex', gap: '20px', alignItems: 'flex-end', flexWrap: 'wrap' }}>
                                <div style={{ flex: 1, minWidth: '200px' }}>
                                    <label>Category</label>
                                    <select value={category} onChange={e => setCategory(e.target.value)}>
                                        {categories.map(c => (
                                            <option key={c} value={c}>{c}</option>
                                        ))}
                                    </select>
                                </div>
                                <div style={{ flex: 1, minWidth: '200px' }}>
                                    <label>Budget Limit (₹)</label>
                                    <input
                                        type="number"
                                        value={amount}
                                        onChange={e => setAmount(e.target.value)}
                                        placeholder="Enter amount"
                                        required
                                        style={{ marginBottom: 0 }}
                                    />
                                </div>
                                <button type="submit" className="approve-btn" style={{ marginBottom: 0, height: '46px' }}>
                                    Save Budget
                                </button>
                                <button
                                    type="button"
                                    className="delete-btn"
                                    onClick={() => setShowCreateForm(false)}
                                    style={{ marginBottom: 0, height: '46px' }}
                                >
                                    Cancel
                                </button>
                            </form>
                        </div>
                    )}

                    {/* Summary Cards Row */}
                    <div style={{ display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(300px, 1fr))', gap: '24px', marginBottom: '40px' }}>
                        {/* Total Budgets */}
                        <div style={{
                            background: '#1e293b',
                            padding: '24px',
                            borderRadius: '16px',
                            border: '1px solid #334155',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div>
                                <div style={{ color: '#94a3b8', fontSize: '0.9rem', marginBottom: '8px', fontWeight: '600' }}>Total Budgets</div>
                                <div style={{ fontSize: '2rem', fontWeight: '700', color: '#60a5fa' }}>{formatCurrency(totalBudget)}</div>
                            </div>
                            <div style={{
                                width: '48px',
                                height: '48px',
                                borderRadius: '12px',
                                background: 'rgba(96, 165, 250, 0.15)',
                                color: '#60a5fa',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '1.5rem'
                            }}>
                                $
                            </div>
                        </div>

                        {/* Total Spent */}
                        <div style={{
                            background: '#1e293b',
                            padding: '24px',
                            borderRadius: '16px',
                            border: '1px solid #334155',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div>
                                <div style={{ color: '#94a3b8', fontSize: '0.9rem', marginBottom: '8px', fontWeight: '600' }}>Total Spent</div>
                                <div style={{ fontSize: '2rem', fontWeight: '700', color: '#4ade80' }}>{formatCurrency(totalSpent)}</div>
                            </div>
                            <div style={{
                                width: '48px',
                                height: '48px',
                                borderRadius: '12px',
                                background: 'rgba(74, 222, 128, 0.15)',
                                color: '#4ade80',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '1.5rem'
                            }}>
                                ↗
                            </div>
                        </div>

                        {/* Remaining */}
                        <div style={{
                            background: '#1e293b',
                            padding: '24px',
                            borderRadius: '16px',
                            border: '1px solid #334155',
                            display: 'flex',
                            justifyContent: 'space-between',
                            alignItems: 'center',
                            boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)'
                        }}>
                            <div>
                                <div style={{ color: '#94a3b8', fontSize: '0.9rem', marginBottom: '8px', fontWeight: '600' }}>Remaining</div>
                                <div style={{ fontSize: '2rem', fontWeight: '700', color: '#c084fc' }}>{formatCurrency(totalRemaining)}</div>
                            </div>
                            <div style={{
                                width: '48px',
                                height: '48px',
                                borderRadius: '12px',
                                background: 'rgba(192, 132, 252, 0.15)',
                                color: '#c084fc',
                                display: 'flex',
                                alignItems: 'center',
                                justifyContent: 'center',
                                fontSize: '1.5rem'
                            }}>
                                📅
                            </div>
                        </div>
                    </div>

                    {/* Budget Cards List */}
                    <div style={{ display: 'flex', flexDirection: 'column', gap: '24px' }}>
                        {budgets.map(budget => {
                            const { used, remaining, percent } = getBudgetStats(budget);
                            let color = '#34d399'; // Green (Safe)
                            if (percent > 70) color = '#fbbf24'; // Yellow (Warning)
                            if (percent > 90) color = '#f87171'; // Red (Danger)

                            const currentYear = new Date().getFullYear();

                            return (
                                <div
                                    key={budget.id}
                                    onClick={() => setSelectedBudget(budget)}
                                    style={{
                                        background: '#1e293b',
                                        border: '1px solid #334155',
                                        borderRadius: '12px',
                                        padding: '24px',
                                        position: 'relative',
                                        transition: 'all 0.2s',
                                        boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1)',
                                        cursor: 'pointer'
                                    }}
                                    onMouseEnter={(e) => e.currentTarget.style.borderColor = '#6366f1'}
                                    onMouseLeave={(e) => e.currentTarget.style.borderColor = '#334155'}
                                >
                                    {/* Top Row: Title, Metadata, Status Badge, Actions */}
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '24px' }}>
                                        <div>
                                            <h3 style={{ fontSize: '1.25rem', margin: '0 0 8px 0', color: '#F9FAFB' }}>{budget.category} Budget {currentYear}</h3>
                                            <div style={{ color: '#94a3b8', fontSize: '0.9rem' }}>
                                                Category: <span style={{ color: '#e2e8f0' }}>{budget.category}</span>
                                                <span style={{ margin: '0 8px' }}>•</span>
                                                Period: <span style={{ color: '#e2e8f0' }}>Yearly</span>
                                            </div>
                                        </div>

                                        <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                            <span style={{
                                                background: `rgba(${parseInt(color.slice(1, 3), 16)}, ${parseInt(color.slice(3, 5), 16)}, ${parseInt(color.slice(5, 7), 16)}, 0.15)`,
                                                color: color,
                                                padding: '4px 12px',
                                                borderRadius: '20px',
                                                fontSize: '0.85rem',
                                                fontWeight: '600'
                                            }}>
                                                {percent.toFixed(1)}% Used
                                            </span>

                                            {/* Actions */}
                                            <button
                                                type="button"
                                                title="Edit Limit"
                                                onClick={(e) => startEdit(e, budget)}
                                                style={{ background: 'transparent', border: 'none', cursor: 'pointer', fontSize: '1.1rem' }}
                                            >
                                                ✏️
                                            </button>
                                            <button
                                                type="button"
                                                title="Delete Budget"
                                                onClick={(e) => confirmDelete(e, budget.id)}
                                                style={{ background: 'transparent', border: 'none', cursor: 'pointer', fontSize: '1.1rem' }}
                                            >
                                                🗑️
                                            </button>
                                        </div>
                                    </div>

                                    {/* Stats Row */}
                                    <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '16px', fontSize: '0.95rem', color: '#94a3b8' }}>
                                        <div>Budget: <span style={{ color: '#e2e8f0', fontWeight: '600' }}>{formatCurrency(budget.limit)}</span></div>
                                        <div>Spent: <span style={{ color: '#e2e8f0', fontWeight: '600' }}>{formatCurrency(used)}</span></div>
                                        <div style={{ color: '#34d399', fontWeight: '700' }}>Remaining: {formatCurrency(remaining)}</div>
                                    </div>

                                    {/* Progress Bar */}
                                    <div style={{
                                        width: '100%',
                                        height: '8px',
                                        background: '#334155',
                                        borderRadius: '4px',
                                        overflow: 'hidden',
                                        marginBottom: '12px'
                                    }}>
                                        <div style={{
                                            width: `${percent}%`,
                                            height: '100%',
                                            background: color,
                                            borderRadius: '4px',
                                            transition: 'width 0.6s cubic-bezier(0.4, 0, 0.2, 1)'
                                        }}></div>
                                    </div>

                                    {/* Footer: Date Range */}
                                    <div style={{ display: 'flex', justifyContent: 'space-between', fontSize: '0.8rem', color: '#64748b' }}>
                                        <span>1/1/{currentYear}</span>
                                        <span>12/31/{currentYear}</span>
                                    </div>
                                </div>
                            );
                        })}
                    </div>
                </div>
            );
        }

        // User Creation Component (for Admin)
        function UserCreation({ onCreateUser }) {
            const [email, setEmail] = useState('');
            const [role, setRole] = useState('EMPLOYEE');
            const [createdUser, setCreatedUser] = useState(null);

            const handleCreate = (e) => {
                e.preventDefault();
                const newUser = onCreateUser(email, role);
                if (newUser) {
                    setCreatedUser(newUser);
                    setEmail('');
                }
            };

            return (
                <div className="card" style={{ marginBottom: '24px' }}>
                    <h2>Create New User</h2>
                    <p style={{ color: '#9CA3AF', marginBottom: '20px' }}>
                        Enter the email address for the new employee or manager. A secure password will be automatically generated.
                    </p>

                    <form onSubmit={handleCreate} style={{ display: 'flex', gap: '15px', alignItems: 'flex-end', flexWrap: 'wrap' }}>
                        <div style={{ flex: 2, minWidth: '250px' }}>
                            <label>Email Address</label>
                            <input
                                type="email"
                                value={email}
                                onChange={e => setEmail(e.target.value)}
                                placeholder="new.user@company.com"
                                required
                                style={{ marginBottom: 0 }}
                            />
                        </div>
                        <div style={{ flex: 1, minWidth: '150px' }}>
                            <label>Role</label>
                            <select value={role} onChange={e => setRole(e.target.value)} style={{ marginBottom: 0 }}>
                                <option value="EMPLOYEE">Employee</option>
                                <option value="MANAGER">Manager</option>
                            </select>
                        </div>
                        <button type="submit" className="assign-btn" style={{ marginBottom: 0, height: '46px' }}>
                            Create User
                        </button>
                    </form>

                    {createdUser && (
                        <div style={{
                            marginTop: '20px',
                            padding: '15px',
                            backgroundColor: 'rgba(16, 185, 129, 0.1)',
                            border: '1px solid rgba(16, 185, 129, 0.3)',
                            borderRadius: '8px',
                            animation: 'fadeIn 0.5s'
                        }}>
                            <h4 style={{ color: '#10B981', marginTop: 0 }}>🎉 User Created Successfully!</h4>
                            <p>Please share these credentials with the user:</p>
                            <div style={{ background: '#111827', padding: '10px', borderRadius: '4px', fontFamily: 'monospace' }}>
                                <div style={{ marginBottom: '5px' }}>Email: <strong style={{ color: '#F9FAFB' }}>{createdUser.email}</strong></div>
                                <div>Password: <strong style={{ color: '#F59E0B', fontSize: '1.1em' }}>{createdUser.password}</strong></div>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // User Management Component for Admin
        function UserManagement({ users, onAssignManager, onCreateUser, onDeleteUser, loggedInUser }) {
            const [showCreateModal, setShowCreateModal] = useState(false);
            const [editingUser, setEditingUser] = useState(null); // User being edited (for manager assignment)
            const [selectedManagerId, setSelectedManagerId] = useState('');

            const getManagerName = (managerId) => {
                if (!managerId) return '-';
                const manager = users.find(u => u.id === managerId);
                return manager ? manager.name : 'Unknown';
            };

            const getRoleBadgeStyle = (role) => {
                switch (role) {
                    case 'ADMIN': return { background: 'rgba(239, 68, 68, 0.1)', color: '#F87171', border: '1px solid rgba(239, 68, 68, 0.2)' };
                    case 'MANAGER': return { background: 'rgba(59, 130, 246, 0.1)', color: '#60A5FA', border: '1px solid rgba(59, 130, 246, 0.2)' };
                    case 'EMPLOYEE': return { background: 'rgba(16, 185, 129, 0.1)', color: '#34D399', border: '1px solid rgba(16, 185, 129, 0.2)' };
                    default: return { background: '#374151', color: '#9CA3AF' };
                }
            };

            const handleAssign = (e) => {
                e.preventDefault();
                if (editingUser && selectedManagerId) {
                    onAssignManager(editingUser.id, parseInt(selectedManagerId));
                    setEditingUser(null);
                    setSelectedManagerId('');
                }
            };

            const managers = users.filter(u => u.role === 'MANAGER');

            return (
                <div style={{ padding: '0px' }}>
                    {/* Header */}
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px', background: '#1F2937', padding: '24px', borderRadius: '12px', border: '1px solid #374151' }}>
                        <div>
                            <h2 style={{ fontSize: '1.5rem', marginBottom: '5px', color: '#F9FAFB' }}>User Management</h2>
                            <p style={{ color: '#9CA3AF', margin: 0 }}>{users.length} users in your organization</p>
                        </div>
                        <button
                            type="button"
                            onClick={() => setShowCreateModal(true)}
                            style={{
                                background: '#2563EB',
                                color: 'white',
                                border: 'none',
                                padding: '10px 20px',
                                borderRadius: '8px',
                                fontWeight: '600',
                                cursor: 'pointer',
                                display: 'flex',
                                alignItems: 'center',
                                gap: '8px',
                                transition: 'background 0.2s',
                                fontSize: '0.95rem'
                            }}
                            onMouseEnter={(e) => e.target.style.background = '#1D4ED8'}
                            onMouseLeave={(e) => e.target.style.background = '#2563EB'}
                        >
                            <span style={{ fontSize: '1.2rem' }}>+</span> Add User
                        </button>
                    </div>

                    {/* Users Table */}
                    <div style={{ background: '#1F2937', borderRadius: '12px', border: '1px solid #374151', overflow: 'hidden' }}>
                        <table style={{ width: '100%', borderCollapse: 'collapse', color: '#E5E7EB' }}>
                            <thead>
                                <tr style={{ textAlign: 'left', borderBottom: '1px solid #374151', color: '#9CA3AF', fontSize: '0.75rem', textTransform: 'uppercase', letterSpacing: '0.05em' }}>
                                    <th style={{ padding: '16px 24px', fontWeight: '600' }}>User</th>
                                    <th style={{ padding: '16px 24px', fontWeight: '600' }}>Role</th>
                                    <th style={{ padding: '16px 24px', fontWeight: '600' }}>ID</th>
                                    <th style={{ padding: '16px 24px', fontWeight: '600' }}>Manager</th>
                                    <th style={{ padding: '16px 24px', fontWeight: '600' }}>Created</th>
                                    <th style={{ padding: '16px 24px', fontWeight: '600', textAlign: 'right' }}>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                {users.map(user => (
                                    <tr key={user.id} style={{ borderBottom: '1px solid #374151', fontSize: '0.95rem', transition: 'background 0.15s' }} className="hover:bg-gray-800">
                                        <td style={{ padding: '16px 24px' }}>
                                            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                                <div style={{
                                                    width: '40px', height: '40px', borderRadius: '50%',
                                                    background: '#374151', display: 'flex', alignItems: 'center', justifyContent: 'center',
                                                    color: '#9CA3AF', fontSize: '1.2rem'
                                                }}>
                                                    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                                                        <circle cx="12" cy="7" r="4"></circle>
                                                    </svg>
                                                </div>
                                                <div>
                                                    <div style={{ fontWeight: '600', color: '#F9FAFB' }}>{user.name}</div>
                                                    <div style={{ fontSize: '0.85rem', color: '#9CA3AF' }}>{user.email}</div>
                                                </div>
                                            </div>
                                        </td>
                                        <td style={{ padding: '16px 24px' }}>
                                            <span style={{
                                                padding: '4px 12px', borderRadius: '20px', fontSize: '0.8rem', fontWeight: '600',
                                                display: 'inline-flex', alignItems: 'center', gap: '6px', ...getRoleBadgeStyle(user.role)
                                            }}>
                                                {user.role === 'ADMIN' && '🛡️'}
                                                {user.role === 'MANAGER' && '👥'}
                                                {user.role === 'EMPLOYEE' && '👤'}
                                                {user.role === 'ADMIN' ? 'Admin' : user.role === 'MANAGER' ? 'Manager' : 'Employee'}
                                            </span>
                                        </td>
                                        <td style={{ padding: '16px 24px', color: '#E5E7EB', fontFamily: 'monospace' }}>
                                            {user.uniqueId || '-'}
                                        </td>
                                        <td style={{ padding: '16px 24px', color: '#E5E7EB' }}>
                                            {getManagerName(user.managerId)}
                                        </td>
                                        <td style={{ padding: '16px 24px', color: '#9CA3AF' }}>
                                            {user.created || new Date().toLocaleDateString()}
                                        </td>
                                        <td style={{ padding: '16px 24px', textAlign: 'right' }}>
                                            <div style={{ display: 'flex', justifyContent: 'flex-end', gap: '10px' }}>
                                                <button
                                                    onClick={() => { setEditingUser(user); setSelectedManagerId(user.managerId || ''); }}
                                                    title="Assign Manager"
                                                    style={{ background: 'transparent', border: 'none', cursor: 'pointer', color: '#60A5FA', padding: '4px' }}
                                                >
                                                    <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <path d="M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"></path>
                                                    </svg>
                                                </button>
                                                {user.role !== 'ADMIN' && (
                                                    <button
                                                        onClick={() => { if (window.confirm('Delete this user?')) onDeleteUser(user.id); }}
                                                        title="Delete User"
                                                        style={{ background: 'transparent', border: 'none', cursor: 'pointer', color: '#F87171', padding: '4px' }}
                                                    >
                                                        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                            <polyline points="3 6 5 6 21 6"></polyline>
                                                            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"></path>
                                                        </svg>
                                                    </button>
                                                )}
                                            </div>
                                        </td>
                                    </tr>
                                ))}
                            </tbody>
                        </table>
                    </div>

                    {/* Add User Modal */}
                    {showCreateModal && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.7)', zIndex: 1100, display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                            <div className="card" style={{ width: '450px', position: 'relative' }}>
                                <button onClick={() => setShowCreateModal(false)} style={{ position: 'absolute', top: '15px', right: '15px', background: 'transparent', border: 'none', color: '#9CA3AF', fontSize: '1.2rem', cursor: 'pointer' }}>&times;</button>
                                <UserCreation onCreateUser={(email, role) => {
                                    const user = onCreateUser(email, role);
                                    if (user) setShowCreateModal(false); // Close on success
                                    return user;
                                }} />
                            </div>
                        </div>
                    )}

                    {/* Edit User Modal - Assign Manager to Employee */}
                    {editingUser && (
                        <div style={{ position: 'fixed', top: 0, left: 0, right: 0, bottom: 0, backgroundColor: 'rgba(0,0,0,0.7)', zIndex: 1100, display: 'flex', justifyContent: 'center', alignItems: 'center' }}>
                            <div className="card" style={{ width: '450px', position: 'relative' }}>
                                <button onClick={() => setEditingUser(null)} style={{ position: 'absolute', top: '15px', right: '15px', background: 'transparent', border: 'none', color: '#9CA3AF', fontSize: '1.5rem', cursor: 'pointer' }}>&times;</button>

                                <h3 style={{ marginTop: 0, marginBottom: '8px' }}>Edit User: {editingUser.name}</h3>
                                <p style={{ color: '#9CA3AF', margin: '0 0 20px 0', fontSize: '0.9rem' }}>{editingUser.email}</p>

                                {/* User Info Section */}
                                <div style={{ background: '#374151', padding: '16px', borderRadius: '8px', marginBottom: '20px' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '10px' }}>
                                        <span style={{ color: '#9CA3AF' }}>Role:</span>
                                        <span style={{
                                            padding: '4px 12px',
                                            borderRadius: '20px',
                                            fontSize: '0.8rem',
                                            fontWeight: '600',
                                            background: editingUser.role === 'ADMIN' ? 'rgba(239, 68, 68, 0.1)' : editingUser.role === 'MANAGER' ? 'rgba(59, 130, 246, 0.1)' : 'rgba(16, 185, 129, 0.1)',
                                            color: editingUser.role === 'ADMIN' ? '#F87171' : editingUser.role === 'MANAGER' ? '#60A5FA' : '#34D399'
                                        }}>
                                            {editingUser.role === 'ADMIN' ? '🛡️ Admin' : editingUser.role === 'MANAGER' ? '👥 Manager' : '👤 Employee'}
                                        </span>
                                    </div>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center' }}>
                                        <span style={{ color: '#9CA3AF' }}>Current Manager:</span>
                                        <span style={{ color: '#E5E7EB', fontWeight: '500' }}>{getManagerName(editingUser.managerId)}</span>
                                    </div>
                                </div>

                                {/* Assign Manager Section - Only for Employees and Managers */}
                                {(editingUser.role === 'EMPLOYEE' || editingUser.role === 'MANAGER') && (
                                    <div style={{ background: 'rgba(59, 130, 246, 0.05)', border: '1px solid rgba(59, 130, 246, 0.2)', padding: '20px', borderRadius: '8px' }}>
                                        <h4 style={{ margin: '0 0 8px 0', color: '#60A5FA', display: 'flex', alignItems: 'center', gap: '8px' }}>
                                            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"></path>
                                                <circle cx="9" cy="7" r="4"></circle>
                                                <path d="M22 21v-2a4 4 0 0 0-3-3.87"></path>
                                                <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                                            </svg>
                                            Assign Manager to {editingUser.role === 'EMPLOYEE' ? 'Employee' : 'this Manager'}
                                        </h4>
                                        <p style={{ color: '#9CA3AF', margin: '0 0 16px 0', fontSize: '0.85rem' }}>
                                            {editingUser.role === 'EMPLOYEE'
                                                ? 'Select a manager who will be responsible for approving this employee\'s expenses.'
                                                : 'Assign a reporting manager (Admin) for this manager.'}
                                        </p>
                                        <form onSubmit={handleAssign}>
                                            <label style={{ display: 'block', marginBottom: '8px', fontWeight: '600', color: '#E5E7EB' }}>Select Manager</label>
                                            <select
                                                value={selectedManagerId}
                                                onChange={e => setSelectedManagerId(e.target.value)}
                                                required
                                                style={{ width: '100%', padding: '12px', borderRadius: '8px', background: '#1F2937', color: 'white', border: '1px solid #4B5563', marginBottom: '16px', fontSize: '0.95rem' }}
                                            >
                                                <option value="">-- Select a Manager --</option>
                                                {managers.map(m => (
                                                    <option key={m.id} value={m.id}>{m.name} ({m.email})</option>
                                                ))}
                                            </select>
                                            <div style={{ display: 'flex', gap: '10px', justifyContent: 'flex-end' }}>
                                                <button type="button" onClick={() => setEditingUser(null)} style={{ padding: '10px 20px', background: 'transparent', color: '#9CA3AF', border: '1px solid #4B5563', borderRadius: '8px', cursor: 'pointer', fontWeight: '600' }}>Cancel</button>
                                                <button type="submit" style={{ padding: '10px 20px', background: '#2563EB', color: 'white', border: 'none', borderRadius: '8px', cursor: 'pointer', fontWeight: '600', display: 'flex', alignItems: 'center', gap: '6px' }}>
                                                    <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                        <path d="M20 6L9 17l-5-5"></path>
                                                    </svg>
                                                    Save Assignment
                                                </button>
                                            </div>
                                        </form>
                                    </div>
                                )}

                                {/* Admin users don't need manager assignment */}
                                {editingUser.role === 'ADMIN' && (
                                    <div style={{ background: 'rgba(239, 68, 68, 0.05)', border: '1px solid rgba(239, 68, 68, 0.2)', padding: '16px', borderRadius: '8px', textAlign: 'center' }}>
                                        <p style={{ color: '#F87171', margin: 0, fontSize: '0.9rem' }}>
                                            🛡️ Admin users do not require a manager assignment.
                                        </p>
                                    </div>
                                )}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Security Settings Component
        function SecuritySettings({ user, settings, onUpdateProfile, onUpdateSettings }) {
            const [message, setMessage] = useState({ text: '', type: '' });

            const handleToggle2FA = () => {
                if (!user.profileImage && !user.twoFactorEnabled) {
                    setMessage({
                        text: 'Please upload or capture a profile photo before enabling 2FA.',
                        type: 'error'
                    });
                    setTimeout(() => setMessage({ text: '', type: '' }), 4000);
                    return;
                }
                const newValue = !user.twoFactorEnabled;
                const updatedUser = { ...user, twoFactorEnabled: newValue };
                onUpdateProfile(updatedUser);
                setMessage({
                    text: newValue ? 'Two-Factor Authentication enabled!' : 'Two-Factor Authentication disabled!',
                    type: 'success'
                });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const handleTimeoutChange = (e) => {
                const newValue = parseInt(e.target.value);
                onUpdateSettings({ ...settings, sessionTimeout: newValue });
                setMessage({ text: 'Session timeout updated successfully!', type: 'success' });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            const handleToggleNotifications = () => {
                const newValue = !settings.loginNotifications;
                onUpdateSettings({ ...settings, loginNotifications: newValue });
                setMessage({
                    text: newValue ? 'Login notifications enabled!' : 'Login notifications disabled!',
                    type: 'success'
                });
                setTimeout(() => setMessage({ text: '', type: '' }), 3000);
            };

            return (
                <div style={{ maxWidth: '1000px', margin: '0 auto' }}>
                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                        <h2 style={{ fontSize: '1.8rem', margin: 0, color: '#F9FAFB', border: 'none' }}>Security Settings</h2>
                        {message.text && (
                            <div style={{
                                padding: '8px 16px',
                                borderRadius: '8px',
                                background: message.type === 'error' ? 'rgba(239, 68, 68, 0.1)' : 'rgba(16, 185, 129, 0.1)',
                                color: message.type === 'error' ? '#EF4444' : '#10B981',
                                fontWeight: '600',
                                fontSize: '0.9rem',
                                border: `1px solid ${message.type === 'error' ? 'rgba(239, 68, 68, 0.2)' : 'rgba(16, 185, 129, 0.2)'}`
                            }}>
                                {message.text}
                            </div>
                        )}
                    </div>

                    {/* Two-Factor Authentication */}
                    <div className="security-row">
                        <div className="security-info">
                            <h4>Two-Factor Authentication</h4>
                            <p>Add an extra layer of security to your account</p>
                        </div>
                        <div className="security-action">
                            <button
                                onClick={handleToggle2FA}
                                style={{
                                    backgroundColor: user.twoFactorEnabled ? '#EF4444' : '#2563EB',
                                    color: 'white',
                                    border: 'none',
                                    padding: '10px 24px',
                                    borderRadius: '8px',
                                    fontWeight: '600',
                                    cursor: 'pointer',
                                    transition: 'all 0.2s'
                                }}
                            >
                                {user.twoFactorEnabled ? 'Disable' : 'Enable'}
                            </button>
                        </div>
                    </div>

                    {/* Session Timeout */}
                    <div className="security-row">
                        <div className="security-info">
                            <h4>Session Timeout</h4>
                            <p>Automatically log out after inactivity</p>
                        </div>
                        <div className="security-action">
                            <select value={settings.sessionTimeout} onChange={handleTimeoutChange}>
                                <option value="5">5 minutes</option>
                                <option value="15">15 minutes</option>
                                <option value="30">30 minutes</option>
                                <option value="60">60 minutes</option>
                            </select>
                        </div>
                    </div>

                    {/* Login Notifications */}
                    <div className="security-row">
                        <div className="security-info">
                            <h4>Login Notifications</h4>
                            <p>Get notified of new login attempts</p>
                        </div>
                        <div className="security-action">
                            <label className="switch">
                                <input
                                    type="checkbox"
                                    checked={settings.loginNotifications}
                                    onChange={handleToggleNotifications}
                                />
                                <span className="slider"></span>
                            </label>
                        </div>
                    </div>
                </div>
            );
        }

        // Manager & Admin Dashboard
        function ManagerAdminDashboard({ loggedInUser, users, expenses, budgets, settings, onExpenseUpdate, onAssignManager, onAddBudget, onEditBudget, onDeleteBudget, onCreateUser, onDeleteUser, onUpdateProfile, onUpdateSettings }) {
            const [showAnalytics, setShowAnalytics] = useState(false);
            const [activeTab, setActiveTab] = useState('overview'); // overview, budget, users
            const isManager = loggedInUser.role === 'MANAGER';
            const isAdmin = loggedInUser.role === 'ADMIN';

            useEffect(() => {
                gsap.from(".summary-card", {
                    opacity: 0,
                    y: 20,
                    stagger: 0.1,
                    duration: 0.5,
                    ease: "power2.out"
                });
                gsap.from(".dashboard .card", {
                    opacity: 0,
                    y: 20,
                    delay: 0.3,
                    duration: 0.5,
                    ease: "power2.out"
                });
            }, []);

            // Get team members for manager - employees assigned to this manager
            const myTeamMemberIds = isManager ?
                users.filter(u => u.managerId === loggedInUser.id).map(u => u.id) : [];

            // Manager sees only their team's PENDING expenses
            const managerApprovalQueue = isManager
                ? expenses.filter(e => myTeamMemberIds.includes(e.employeeId) && e.status === 'PENDING')
                : [];

            // Admin sees ALL pending and manager-approved expenses for final approval
            const adminApprovalQueue = isAdmin
                ? expenses.filter(e => e.status === 'PENDING' || e.status === 'MANAGER_APPROVED')
                : [];

            // Monthly Expenses (only fully approved by Admin)
            const currentMonthPrefix = new Date().toISOString().slice(0, 7);
            const monthlyExpenses = expenses
                .filter(e => e.date.startsWith(currentMonthPrefix) && e.status === 'APPROVED')
                .reduce((sum, e) => sum + e.amount, 0);

            const formatCurrency = (val) => `₹${Number(val).toLocaleString('en-IN')}`;

            const handleManagerApproval = (expenseId, isApproved) => {
                const newStatus = isApproved ? "MANAGER_APPROVED" : "REJECTED";
                onExpenseUpdate(expenseId, newStatus);
            };

            const handleAdminApproval = (expenseId, isApproved) => {
                const newStatus = isApproved ? "APPROVED" : "REJECTED";
                onExpenseUpdate(expenseId, newStatus);
            };

            const getUserName = (userId) => {
                const user = users.find(u => u.id === userId);
                return user ? user.name : 'Unknown User';
            };

            const getManagerName = (employeeId) => {
                const employee = users.find(u => u.id === employeeId);
                if (!employee) return 'Unknown';
                const manager = users.find(u => u.id === employee.managerId);
                return manager ? manager.name : 'No Manager Assigned';
            };

            return (
                <div className="dashboard-container">
                    {/* Navigation Tabs */}
                    <div className="admin-nav">
                        <button
                            className={activeTab === 'overview' ? 'active' : ''}
                            onClick={() => setActiveTab('overview')}
                        >
                            Overview
                        </button>
                        {isAdmin && (
                            <>
                                <button
                                    type="button"
                                    className={activeTab === 'budget' ? 'active' : ''}
                                    onClick={() => setActiveTab('budget')}
                                >
                                    Budget Management
                                </button>
                                <button
                                    type="button"
                                    className={activeTab === 'users' ? 'active' : ''}
                                    onClick={() => setActiveTab('users')}
                                >
                                    User Management
                                </button>
                                <button
                                    className={activeTab === 'security' ? 'active' : ''}
                                    onClick={() => setActiveTab('security')}
                                >
                                    Security
                                </button>
                            </>
                        )}
                        <button
                            className={activeTab === 'profile' ? 'active' : ''}
                            onClick={() => setActiveTab('profile')}
                        >
                            My Profile
                        </button>
                    </div>

                    {showAnalytics && <AnalyticsModal expenses={expenses} users={users} onClose={() => setShowAnalytics(false)} />}

                    {/* CONDITIONAL RENDERING BASED ON TAB */}

                    {/* TAB: PROFILE */}
                    {activeTab === 'profile' && (
                        <ProfilePage
                            user={loggedInUser}
                            onUpdateProfile={onUpdateProfile}
                            users={users}
                        />
                    )}

                    {/* TAB: BUDGET */}
                    {isAdmin && activeTab === 'budget' && (
                        <BudgetManagement
                            budgets={budgets}
                            expenses={expenses}
                            users={users}
                            onAddBudget={onAddBudget}
                            onEditBudget={onEditBudget}
                            onDeleteBudget={onDeleteBudget}
                        />
                    )}

                    {/* TAB: USERS */}
                    {isAdmin && activeTab === 'users' && (
                        <UserManagement
                            users={users}
                            onAssignManager={onAssignManager}
                            onCreateUser={onCreateUser}
                            onDeleteUser={onDeleteUser}
                            loggedInUser={loggedInUser}
                        />
                    )}

                    {/* TAB: SECURITY */}
                    {isAdmin && activeTab === 'security' && (
                        <SecuritySettings
                            user={loggedInUser}
                            settings={settings}
                            onUpdateProfile={onUpdateProfile}
                            onUpdateSettings={onUpdateSettings}
                        />
                    )}

                    {/* TAB: OVERVIEW (Default) */}
                    {activeTab === 'overview' && (
                        <div className="dashboard">

                            <div className="summary-cards" style={{ gridColumn: '1 / -1', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(240px, 1fr))', gap: '20px', marginBottom: '30px' }}>
                                {/* Card 4: Pending Approval - Yellow */}
                                <div className="summary-card" style={{ background: 'rgba(245, 158, 11, 0.1)', border: '1px solid rgba(245, 158, 11, 0.2)', color: '#FBBF24' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <div style={{ fontSize: '0.9rem', marginBottom: '5px', color: '#FCD34D' }}>Pending Approval</div>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>
                                                {isManager ? managerApprovalQueue.length : adminApprovalQueue.length}
                                            </div>
                                        </div>
                                        <div style={{ padding: '10px', background: 'rgba(245, 158, 11, 0.2)', borderRadius: '8px', display: 'flex' }}>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <polygon points="22 3 2 3 10 12.46 10 19 14 21 14 12.46 22 3"></polygon>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                {/* Card 2: Total Amount - Green */}
                                <div className="summary-card" style={{ background: 'rgba(16, 185, 129, 0.1)', border: '1px solid rgba(16, 185, 129, 0.2)', color: '#34D399' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <div style={{ fontSize: '0.9rem', marginBottom: '5px', color: '#6EE7B7' }}>Total Amount</div>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{formatCurrency(expenses.reduce((sum, e) => sum + e.amount, 0))}</div>
                                        </div>
                                        <div style={{ padding: '10px', background: 'rgba(16, 185, 129, 0.2)', borderRadius: '8px', display: 'flex' }}>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <line x1="12" y1="1" x2="12" y2="23"></line>
                                                <path d="M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                {/* Card 3: Average Expense - Purple */}
                                <div className="summary-card" style={{ background: 'rgba(139, 92, 246, 0.1)', border: '1px solid rgba(139, 92, 246, 0.2)', color: '#A78BFA' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <div style={{ fontSize: '0.9rem', marginBottom: '5px', color: '#C4B5FD' }}>Average Expense</div>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>
                                                {formatCurrency(expenses.length > 0 ? expenses.reduce((sum, e) => sum + e.amount, 0) / expenses.length : 0)}
                                            </div>
                                        </div>
                                        <div style={{ padding: '10px', background: 'rgba(139, 92, 246, 0.2)', borderRadius: '8px', display: 'flex' }}>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline>
                                                <polyline points="17 6 23 6 23 12"></polyline>
                                            </svg>
                                        </div>
                                    </div>
                                </div>

                                {/* Card 1: Total Expenses (Count) - Blue */}
                                <div className="summary-card" style={{ background: 'rgba(59, 130, 246, 0.1)', border: '1px solid rgba(59, 130, 246, 0.2)', color: '#60A5FA' }}>
                                    <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start' }}>
                                        <div>
                                            <div style={{ fontSize: '0.9rem', marginBottom: '5px', color: '#93C5FD' }}>Total Expenses</div>
                                            <div style={{ fontSize: '2rem', fontWeight: 'bold' }}>{expenses.length}</div>
                                        </div>
                                        <div style={{ padding: '10px', background: 'rgba(59, 130, 246, 0.2)', borderRadius: '8px', display: 'flex' }}>
                                            <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
                                                <path d="M12 20V10"></path><path d="M18 20V4"></path><path d="M6 20v-4"></path>
                                            </svg>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            {isAdmin && (
                                <div style={{ gridColumn: '1 / -1', marginBottom: '10px' }}>
                                    <button
                                        onClick={() => setShowAnalytics(true)}
                                        style={{
                                            width: '100%',
                                            padding: '12px',
                                            backgroundColor: '#4F46E5',
                                            color: 'white',
                                            border: 'none',
                                            borderRadius: '8px',
                                            fontWeight: 'bold',
                                            cursor: 'pointer',
                                            display: 'flex',
                                            justifyContent: 'center',
                                            alignItems: 'center',
                                            gap: '8px'
                                        }}
                                    >
                                        <span>View Graphical Analytics</span>
                                        <span>📊</span>
                                    </button>
                                </div>
                            )}

                            {/* User Management removed from here as it's now in a tab */}

                            {/* MANAGER APPROVAL QUEUE */}
                            {isManager && (
                                <div className="card" style={{ gridColumn: '1 / -1' }}>
                                    <h2>Manager Approval Queue ({managerApprovalQueue.length})</h2>
                                    {managerApprovalQueue.length > 0 ? (
                                        <ul>
                                            {managerApprovalQueue.map(exp => (
                                                <li key={exp.id}>
                                                    <div>
                                                        <strong>{getUserName(exp.employeeId)}</strong>: {exp.name}<br />
                                                        {formatCurrency(exp.amount)} • {exp.category}<br />
                                                        <small>Date: {exp.date}</small>
                                                    </div>
                                                    <div>
                                                        <button type="button" className="approve-btn" onClick={() => handleManagerApproval(exp.id, true)}>
                                                            Approve
                                                        </button>
                                                        <button type="button" className="reject-btn" onClick={() => handleManagerApproval(exp.id, false)}>
                                                            Reject
                                                        </button>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : <p>No pending expenses for approval</p>}
                                </div>
                            )}

                            {/* ADMIN APPROVAL QUEUE */}
                            {isAdmin && (
                                <div className="card" style={{ gridColumn: '1 / -1' }}>
                                    <h2>Admin Approval Queue ({adminApprovalQueue.length})</h2>
                                    {adminApprovalQueue.length > 0 ? (
                                        <ul>
                                            {adminApprovalQueue.map(exp => (
                                                <li key={exp.id}>
                                                    <div>
                                                        <strong>{getUserName(exp.employeeId)}</strong>: {exp.name}<br />
                                                        {formatCurrency(exp.amount)} • {exp.category}<br />
                                                        <small>Date: {exp.date} • Manager: {getManagerName(exp.employeeId)}</small>
                                                    </div>
                                                    <div>
                                                        <button type="button" className="approve-btn" onClick={() => handleAdminApproval(exp.id, true)}>
                                                            Approve
                                                        </button>
                                                        <button type="button" className="reject-btn" onClick={() => handleAdminApproval(exp.id, false)}>
                                                            Reject
                                                        </button>
                                                    </div>
                                                </li>
                                            ))}
                                        </ul>
                                    ) : <p>No expenses pending approval</p>}
                                </div>
                            )}

                            {/* ALL EXPENSES VIEW */}
                            <div className="card" style={{ gridColumn: '1 / -1' }}>
                                <h2>All Expenses ({expenses.length})</h2>
                                {expenses.length > 0 ? (
                                    <ul style={{ maxHeight: '400px', overflowY: 'auto' }}>
                                        {expenses.map(exp => (
                                            <li key={exp.id}>
                                                <div>
                                                    <strong>{getUserName(exp.employeeId)}</strong>: {exp.name}<br />
                                                    {formatCurrency(exp.amount)} • {exp.category} • {exp.date}<br />
                                                    <small>Manager: {getManagerName(exp.employeeId)}</small>
                                                </div>
                                                <span className={`status-badge status-${exp.status.toLowerCase().replace('_', '-')}`}>
                                                    {exp.status.replace('_', ' ')}
                                                </span>
                                            </li>
                                        ))}
                                    </ul>
                                ) : <p>No expenses found</p>}
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        // Dashboard Wrapper
        function Dashboard({ loggedInUser, onLogout, users, expenses, budgets, settings, notifications, onExpenseSubmit, onExpenseUpdate, onExportData, onImportData, onClearData, onAssignManager, onClearNotifications, onAddBudget, onEditBudget, onDeleteBudget, onCreateUser, onDeleteUser, onUpdateProfile, onUpdateSettings }) {
            const [message, setMessage] = useState('');
            const [showMessage, setShowMessage] = useState(false);
            const [showNotifications, setShowNotifications] = useState(false);

            useEffect(() => {
                gsap.from(".dashboard-wrapper", { opacity: 0, duration: 0.5, ease: "power2.out" });
            }, []);

            // Filter notifications for loggedInUser
            const myNotifications = notifications
                .filter(n => n.recipientId === loggedInUser.id)
                .sort((a, b) => new Date(b.date) - new Date(a.date));

            const unreadCount = myNotifications.filter(n => !n.read).length;

            const handleFileImport = (e) => {
                const file = e.target.files[0];
                if (file) {
                    onImportData(file);
                    setMessage('Data imported successfully!');
                    setShowMessage(true);
                    setTimeout(() => setShowMessage(false), 3000);
                }
                e.target.value = ''; // Reset file input
            };

            const handleExport = () => {
                onExportData();
                setMessage('Data exported successfully!');
                setShowMessage(true);
                setTimeout(() => setShowMessage(false), 3000);
            };

            const handleClear = () => {
                const result = onClearData();
                if (result) {
                    setMessage('All data cleared successfully! Employees and expenses reset to zero.');
                    setShowMessage(true);
                    setTimeout(() => setShowMessage(false), 5000);
                }
            };

            const handleNotificationClick = () => {
                setShowNotifications(!showNotifications);
            };

            return (
                <div className="dashboard-wrapper" style={{ padding: '20px', minHeight: '100vh', background: '#0F172A', color: 'white' }}>
                    <div style={{
                        textAlign: "center",
                        marginBottom: "32px",
                        background: 'rgba(30, 41, 59, 0.7)',
                        padding: '24px',
                        borderRadius: '20px',
                        border: '1px solid rgba(255,255,255,0.1)',
                        backdropFilter: 'blur(10px)',
                        boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.2)'
                    }}>
                        <h1 style={{ margin: '0 0 20px 0', fontSize: '2rem', letterSpacing: '2px', fontWeight: '800', background: 'linear-gradient(to right, #6366F1, #A855F7)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent' }}>LedgerCore</h1>

                        <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', flexWrap: 'wrap', gap: '20px' }}>
                            {/* User Profile Info */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '16px' }}>
                                <div style={{
                                    width: '56px',
                                    height: '56px',
                                    borderRadius: '50%',
                                    background: loggedInUser.profileImage ? `url("${loggedInUser.profileImage}")` : 'linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%)',
                                    backgroundSize: 'cover',
                                    backgroundPosition: 'center',
                                    border: '3px solid rgba(255,255,255,0.2)',
                                    boxShadow: '0 4px 12px rgba(0,0,0,0.3)',
                                    display: 'flex',
                                    alignItems: 'center',
                                    justifyContent: 'center'
                                }}>
                                    {!loggedInUser.profileImage && <span style={{ color: 'white', fontWeight: 'bold', fontSize: '1.2rem' }}>{loggedInUser.name.charAt(0).toUpperCase()}</span>}
                                </div>
                                <div style={{ textAlign: 'left' }}>
                                    <p style={{ margin: 0, fontSize: '1.15rem', color: 'white', fontWeight: '600' }}>Welcome back, {loggedInUser.name}</p>
                                    <p style={{ margin: 0, fontSize: '0.85rem', color: '#94A3B8', fontWeight: '500' }}>
                                        {loggedInUser.role} | {loggedInUser.uniqueId || '84729103'}
                                    </p>
                                </div>
                            </div>

                            {/* Actions & Notifications */}
                            <div style={{ display: 'flex', alignItems: 'center', gap: '12px' }}>
                                <div className="notification-container">
                                    <button type="button" className="notification-bell" onClick={handleNotificationClick} title="Notifications" style={{ background: 'rgba(255,255,255,0.05)', border: '1px solid rgba(255,255,255,0.1)', padding: '10px', borderRadius: '12px', cursor: 'pointer' }}>
                                        🔔
                                        {unreadCount > 0 && <span className="notification-badge" style={{ top: '-5px', right: '-5px' }}>{unreadCount}</span>}
                                    </button>
                                    {showNotifications && (
                                        <NotificationPanel
                                            notifications={myNotifications}
                                            onClear={() => onClearNotifications(loggedInUser.id)}
                                            onClose={() => setShowNotifications(false)}
                                        />
                                    )}
                                </div>

                                <button type="button" onClick={onLogout} className="logout-btn" style={{ margin: 0, padding: '10px 24px', borderRadius: '12px', background: '#EF4444', color: 'white', fontWeight: 'bold' }}>Logout</button>
                            </div>
                        </div>

                        {/* Data Management & Messages */}
                        <div style={{ marginTop: '20px', display: 'flex', justifyContent: 'center', gap: '12px', alignItems: 'center' }}>
                            <button type="button" className="backup-btn" onClick={handleExport} style={{ fontSize: '0.8rem', opacity: 0.8 }}>Export Backup</button>
                            {loggedInUser.role === 'ADMIN' && (
                                <button type="button" className="delete-btn" onClick={handleClear} style={{ fontSize: '0.8rem', opacity: 0.8 }}>Clear All</button>
                            )}
                            {showMessage && <span style={{ fontSize: '0.85rem', color: '#10B981', marginLeft: '10px' }}>{message}</span>}
                        </div>
                    </div>

                    <div className="dashboard-content">
                        {loggedInUser.role === 'EMPLOYEE' ? (
                            <EmployeeDashboard
                                loggedInUser={loggedInUser}
                                expenses={expenses}
                                users={users}
                                onExpenseSubmit={onExpenseSubmit}
                                onExpenseUpdate={onExpenseUpdate}
                                onUpdateProfile={onUpdateProfile}
                            />
                        ) : (
                            <ManagerAdminDashboard
                                loggedInUser={loggedInUser}
                                users={users}
                                expenses={expenses}
                                budgets={budgets}
                                settings={settings}
                                onExpenseUpdate={onExpenseUpdate}
                                onAssignManager={onAssignManager}
                                onAddBudget={onAddBudget}
                                onEditBudget={onEditBudget}
                                onDeleteBudget={onDeleteBudget}
                                onCreateUser={onCreateUser}
                                onDeleteUser={onDeleteUser}
                                onUpdateProfile={onUpdateProfile}
                                onUpdateSettings={onUpdateSettings}
                            />
                        )}
                    </div>
                </div>
            );
        }

        // Main App
        function App() {
            // Try to restore session from sessionStorage on page load
            const getInitialUser = () => {
                try {
                    const savedUser = sessionStorage.getItem('ledgercore_user');
                    return savedUser ? JSON.parse(savedUser) : null;
                } catch (e) {
                    return null;
                }
            };

            const getInitialView = () => {
                try {
                    const savedView = sessionStorage.getItem('ledgercore_view');
                    return savedView || 'landing';
                } catch (e) {
                    return 'landing';
                }
            };

            const [view, setView] = useState(getInitialView);
            const [loggedInUser, setLoggedInUser] = useState(getInitialUser);
            const [pending2FAUser, setPending2FAUser] = useState(null);
            const [authMessage, setAuthMessage] = useState({ text: '', type: '' });
            const [data, setData] = useState(initialData);

            // Persist session to sessionStorage whenever it changes
            useEffect(() => {
                if (loggedInUser) {
                    sessionStorage.setItem('ledgercore_user', JSON.stringify(loggedInUser));
                    sessionStorage.setItem('ledgercore_view', view);
                } else {
                    sessionStorage.removeItem('ledgercore_user');
                    sessionStorage.removeItem('ledgercore_view');
                }
            }, [loggedInUser, view]);

            const refreshData = async () => {
                try {
                    const result = await ApiService.getData();
                    setData(result);
                } catch (e) {
                    console.error("Failed to fetch data", e);
                }
            };

            useEffect(() => {
                refreshData();
            }, []);

            // Session Timeout Logic
            useEffect(() => {
                if (!loggedInUser) return;

                let timeoutId;
                const timeoutMinutes = (data.settings && data.settings.sessionTimeout) || 30;
                const timeoutMs = timeoutMinutes * 60 * 1000;

                const resetTimer = () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    timeoutId = setTimeout(() => {
                        console.log('Session timed out due to inactivity');
                        handleLogout();
                        alert('Your session has timed out due to inactivity. Please log in again.');
                    }, timeoutMs);
                };

                // Initial timer
                resetTimer();

                // Events that reset the timer
                const events = ['mousedown', 'mousemove', 'keypress', 'scroll', 'touchstart'];
                events.forEach(event => document.addEventListener(event, resetTimer));

                return () => {
                    if (timeoutId) clearTimeout(timeoutId);
                    events.forEach(event => document.removeEventListener(event, resetTimer));
                };
            }, [loggedInUser, data.settings]);

            // Helper to add notification
            const addNotification = (recipientId, message) => {
                const newNote = {
                    id: Date.now() + Math.random(),
                    recipientId,
                    message,
                    date: new Date().toISOString(),
                    read: false
                };
                return newNote;
            };

            const generateUniqueId = () => {
                return Math.floor(10000000 + Math.random() * 90000000).toString();
            };

            const handleSignUp = async (newUser) => {
                if (newUser.password !== newUser.confirmPassword) {
                    setAuthMessage({ text: "Passwords do not match.", type: 'error' });
                    return;
                }

                try {
                    setAuthMessage({ text: '', type: '' });
                    let managerId = null;
                    if (newUser.role === 'MANAGER') {
                        const admin = data.users.find(u => u.role === 'ADMIN');
                        managerId = admin ? admin.id : null;
                    }

                    const userToCreate = {
                        name: newUser.name,
                        email: newUser.email,
                        password: newUser.password,
                        role: newUser.role,
                        managerId: managerId,
                        created: new Date().toLocaleDateString(),
                        uniqueId: generateUniqueId()
                    };

                    await ApiService.signup(userToCreate);

                    const admins = data.users.filter(u => u.role === 'ADMIN');
                    const adminNotes = admins.map(admin => {
                        let msg = `New ${newUser.role} ${newUser.name} registered.`;
                        return addNotification(admin.id, msg);
                    });

                    if (adminNotes.length > 0) {
                        await ApiService.saveNotifications(adminNotes);
                    }

                    await refreshData();
                    setView('login');
                    setAuthMessage({ text: "Account created successfully! Please log in.", type: 'success' });
                } catch (e) {
                    setAuthMessage({ text: "Sign up failed. Email might already be in use.", type: 'error' });
                }
            };

            const handleLogin = async (email, password) => {
                setAuthMessage({ text: '', type: '' });
                try {
                    const user = await ApiService.login(email, password);
                    if (user.twoFactorEnabled && user.profileImage) {
                        setPending2FAUser(user);
                        setView('face-verify');
                    } else {
                        setLoggedInUser(user);
                        setView('dashboard');
                    }
                } catch (e) {
                    setAuthMessage({ text: "Invalid email or password.", type: 'error' });
                }
            };

            const handleLogout = () => {
                setLoggedInUser(null);
                setAuthMessage({ text: '', type: '' });
                setView('landing');
                // Clear session storage on explicit logout
                sessionStorage.removeItem('ledgercore_user');
                sessionStorage.removeItem('ledgercore_view');
            };

            const handleExpenseSubmit = async (localExpenses) => {
                const newExpenses = localExpenses.map(exp => ({
                    ...exp,
                    id: (Date.now() + Math.random()).toString(),
                    employeeId: loggedInUser.id,
                    status: 'PENDING'
                }));

                try {
                    await ApiService.saveExpenses(newExpenses);

                    let notificationsToAdd = [];
                    if (loggedInUser.managerId) {
                        notificationsToAdd.push(addNotification(
                            loggedInUser.managerId,
                            `Employee ${loggedInUser.name} submitted ${localExpenses.length} expenses.`
                        ));
                    }
                    const admins = data.users.filter(u => u.role === 'ADMIN');
                    admins.forEach(admin => {
                        notificationsToAdd.push(addNotification(
                            admin.id,
                            `Employee ${loggedInUser.name} added ${localExpenses.length} new expenses.`
                        ));
                    });

                    if (notificationsToAdd.length > 0) {
                        await ApiService.saveNotifications(notificationsToAdd);
                    }

                    await refreshData();
                } catch (e) {
                    alert("Failed to submit expenses.");
                }
            };

            const handleAddBudget = async (category, limit) => {
                try {
                    await ApiService.saveBudget(category, limit);
                    await refreshData();
                    alert(`Budget for ${category} set to ₹${limit}`);
                } catch (e) {
                    alert("Failed to add budget.");
                }
            };

            const handleEditBudget = async (id, newLimit) => {
                const budget = data.budgets.find(b => b.id === id);
                if (budget) {
                    await handleAddBudget(budget.category, newLimit);
                }
            };

            const handleDeleteBudget = async (id) => {
                try {
                    await ApiService.deleteBudget(id);
                    await refreshData();
                } catch (e) {
                    alert("Failed to delete budget.");
                }
            };

            const handleDeleteUser = async (userId) => {
                if (userId === loggedInUser.id) {
                    alert("You cannot delete your own account.");
                    return;
                }
                try {
                    await ApiService.deleteUser(userId);
                    await refreshData();
                } catch (e) {
                    alert("Failed to delete user.");
                }
            };

            const handleCreateUser = async (email, role) => {
                if (data.users.find(u => u.email === email)) {
                    alert("A user with this email already exists!");
                    return null;
                }

                const generatedPassword = Math.floor(10000000 + Math.random() * 90000000).toString();

                const newUser = {
                    name: email.split('@')[0],
                    email: email,
                    password: generatedPassword,
                    role: role,
                    managerId: null,
                    created: new Date().toLocaleDateString(),
                    uniqueId: generateUniqueId()
                };

                try {
                    await ApiService.signup(newUser);
                    await refreshData();
                    return newUser;
                } catch (e) {
                    alert("Failed to create user.");
                    return null;
                }
            };

            const handleExpenseUpdate = async (expenseId, newStatus) => {
                const expense = data.expenses.find(e => e.id === expenseId);
                if (!expense) return;

                try {
                    await ApiService.updateExpense(expenseId, newStatus);

                    const employee = data.users.find(u => u.id === expense.employeeId);
                    let notificationsToAdd = [];

                    let empMsg = `Your expense '${expense.name}' was ${newStatus.replace('_', ' ').toLowerCase()}.`;
                    if (newStatus === 'APPROVED') {
                        empMsg = `Admin accepted the expense '${expense.name}'.`;
                    } else if (newStatus === 'REJECTED') {
                        empMsg = `Admin rejected the expense '${expense.name}'.`;
                    }

                    notificationsToAdd.push(addNotification(
                        expense.employeeId,
                        empMsg
                    ));

                    if (newStatus === 'MANAGER_APPROVED') {
                        const admins = data.users.filter(u => u.role === 'ADMIN');
                        admins.forEach(admin => {
                            notificationsToAdd.push(addNotification(
                                admin.id,
                                `Manager approved expense '${expense.name}' for ${employee ? employee.name : 'Unknown'}. Needs Final Approval.`
                            ));
                        });
                    }

                    if (notificationsToAdd.length > 0) {
                        await ApiService.saveNotifications(notificationsToAdd);
                    }

                    await refreshData();
                } catch (e) {
                    alert("Failed to update expense.");
                }
            };

            const handleAssignManager = async (employeeId, managerId) => {
                try {
                    await ApiService.updateUser(employeeId, { managerId });

                    const employee = data.users.find(u => u.id === parseInt(employeeId));
                    const manager = data.users.find(u => u.id === parseInt(managerId));

                    let notificationsToAdd = [];
                    const admins = data.users.filter(u => u.role === 'ADMIN');
                    admins.forEach(admin => {
                        notificationsToAdd.push(addNotification(
                            admin.id,
                            `Successfully assigned Manager ${manager ? manager.name : 'Unknown'} to Employee ${employee ? employee.name : 'Unknown'}.`
                        ));
                    });

                    if (manager) {
                        notificationsToAdd.push(addNotification(
                            manager.id,
                            `New Employee ${employee ? employee.name : 'Unknown'} is assigned to you.`
                        ));
                    }

                    if (employee) {
                        notificationsToAdd.push(addNotification(
                            employee.id,
                            `You have been assigned to Manager ${manager ? manager.name : 'Unknown'}.`
                        ));
                    }

                    if (notificationsToAdd.length > 0) {
                        await ApiService.saveNotifications(notificationsToAdd);
                    }

                    await refreshData();
                    alert('Manager assigned successfully!');
                } catch (e) {
                    alert("Failed to assign manager.");
                }
            };



            const handleClearNotifications = async (userId) => {
                try {
                    await ApiService.clearNotifications(userId);
                    await refreshData();
                } catch (e) {
                    console.error("Failed to clear notifications");
                }
            };

            const handleExportData = () => {
                DataManager.exportData(data);
            };

            const handleUpdateSettings = async (newSettings) => {
                try {
                    await ApiService.updateSettings(newSettings);
                    await refreshData();
                } catch (e) {
                    alert("Failed to update settings.");
                }
            };

            const handleImportData = async (file) => {
                DataManager.importData(file, async (importedData) => {
                    // This is complex for a real backend, usually just alert or ignore
                    alert("Import not supported with backend yet. Use manual database tools.");
                });
            };

            const handleClearData = async () => {
                if (window.confirm('Are you sure you want to clear all data?')) {
                    try {
                        await ApiService.clearAllData();
                        await refreshData();
                        return true;
                    } catch (e) {
                        alert("Failed to clear data.");
                    }
                }
                return false;
            };

            const handleUpdateProfile = async (updatedUser) => {
                try {
                    const { name, phone, profileImage, twoFactorEnabled, password } = updatedUser;
                    await ApiService.updateUser(updatedUser.id, { name, phone, profileImage, twoFactorEnabled, password });
                    await refreshData();
                    // Update the local loggedInUser as well
                    const refreshedUser = (await ApiService.getData()).users.find(u => u.id === updatedUser.id);
                    if (refreshedUser) setLoggedInUser(refreshedUser);
                } catch (e) {
                    alert("Failed to update profile.");
                }
            };

            const renderView = () => {
                switch (view) {
                    case 'landing':
                        return <LandingPage
                            switchToSignUp={() => { setView('signup'); setAuthMessage({ text: '', type: '' }); }}
                            switchToLogin={() => { setView('login'); setAuthMessage({ text: '', type: '' }); }}
                        />;
                    case 'dashboard':
                        return <Dashboard
                            loggedInUser={loggedInUser}
                            onLogout={handleLogout}
                            users={data.users}
                            expenses={data.expenses}
                            notifications={data.notifications || []}
                            settings={data.settings || { sessionTimeout: 30, loginNotifications: true }}
                            onExpenseSubmit={handleExpenseSubmit}
                            onExpenseUpdate={handleExpenseUpdate}
                            onAssignManager={handleAssignManager}
                            onExportData={handleExportData}
                            onImportData={handleImportData}
                            onClearData={handleClearData}
                            onClearNotifications={handleClearNotifications}
                            budgets={data.budgets || []}
                            onAddBudget={handleAddBudget}
                            onEditBudget={handleEditBudget}
                            onDeleteBudget={handleDeleteBudget}
                            onCreateUser={handleCreateUser}
                            onDeleteUser={handleDeleteUser}
                            onUpdateProfile={handleUpdateProfile}
                            onUpdateSettings={handleUpdateSettings}
                        />;
                    case 'login':
                        return <LoginPage
                            onLogin={handleLogin}
                            switchToSignUp={() => { setView('signup'); setAuthMessage({ text: '', type: '' }); }}
                            message={authMessage}
                        />;
                    case 'face-verify':
                        return <FaceVerification
                            user={pending2FAUser}
                            onSuccess={() => {
                                setLoggedInUser(pending2FAUser);
                                setPending2FAUser(null);
                                setView('dashboard');
                            }}
                            onCancel={() => {
                                setPending2FAUser(null);
                                setView('login');
                            }}
                        />;
                    case 'signup':
                    default:
                        return <SignUpPage
                            onSignUp={handleSignUp}
                            switchToLogin={() => { setView('login'); setAuthMessage({ text: '', type: '' }); }}
                            message={authMessage}
                        />;
                }
            };

            return (
                <div className="view-container">
                    {renderView()}
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>

</html>